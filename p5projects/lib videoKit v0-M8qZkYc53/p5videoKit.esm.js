class t{constructor(t,e){this.room_name_prefix="",e?(this.p5_instance=e,this.my_canvas=e._renderer,this.my_canvas||ui_log("p5videoKit !!@ no my_canvas"),this.config=t,this.a_={app_ver:"Present ",store_ver:"6",store_name:"Store-A",store_prefix:"",canvas_size_lock:0,hideui:0,chat_name:"",ui:{setting:"",comment:"",back_color:200,room_name:"VideoKit-Room-1",patch_layout:"Single",canvas_size:"960x540",capture_size:"default",render_size:"Canvas",chat_name:"jht",chat_chk:0,live_index:0,live_chk:0,urects_lock:0,urects_count:0,canvas_resize_ref:"",canvas_data_chk:0,audio_enabled:0,mediaDiv_states:[],patches:[{eff_spec:{ipatch:0,imedia:1,eff_label:"show"}}]},settings:[],patch_instances:[],mediaDivs:[]}):ui_log("p5videoKit !!@ no p5_instance")}draw(){ui_log("p5videoKit draw stub")}}function e({to:t,from:e}){e.loadPixels(),t.copy(e,0,0,e.width,e.height,0,0,t.width,t.height)}function i(t,e,i){let s=(i=i||{}).flushRight,h=i.fliph,a=i.flipv;e||(e={width:width,height:height,x0:0,y0:0});let r=e.width,o=e.height,n=t.width,p=t.height,l=p/n;o==p||(l<1?o=r*l:r=o/l);let _=e.x0,c=e.y0;s&&(_+=(e.width-r)/2),h||a?(push(),translate(h?_+r:0,a?c+o:0),scale(h?-1:1,a?-1:1),h&&(_=0),a&&(c=0),image(t,_,c,r,o,0,0,n,p),pop()):image(t,_,c,r,o,0,0,n,p)}function s(t,e,i,s,h){if(!e)return;i||(i={width:width,height:height,x0:0,y0:0});let a=i.width,r=i.height,o=e.width,n=e.height,p=n/o,l=0,_=0;p<1?(r=a*p,s&&(_+=(i.height-r)/2)):(a=r/p,s&&(l+=(i.width-a)/2)),h&&(t.push(),t.scale(-1,1)),t.clear(),h&&(l=-a),t.image(e,l,_,a,r,0,0,o,n),h&&t.pop()}t.prototype.draw=function(){if(this.a_initStarted||(this.a_initStarted=1,this.init()),!this.a_initDone)return;let t;this.set_background(),stroke(255),this.a_.ui.urects_count||(ui_log("draw this.a_.ui.urects_count",this.a_.ui.urects_count),this.pad_layout_update());for(let e=0;e<this.a_.ui.patches.length;e++)t=this.draw_patch(e,t);this.update_ui()},t.prototype.init=async function(){await this.setup(this.config);let t=window.performance.now()-dice.startTime;dice.dapi("stats",{init_lapse:t})},t.prototype.setup=async function(t){this.ui_message("loading...");let e=await this.ui_restore_store(t);resizeCanvas(e.width,e.height),this.init_mediaDivs(t),this.ui_create(),this.a_.ui.hold_capture||this.media_enum(),this.livem_restore(),this.ui_message(""),this.a_initDone=1},t.prototype.draw_patch=async function(t,e){let s=this.a_.ui.patches[t],h=s.eff_spec,{eff_label:a,imedia:r}=h,o=await this.patch_inst_create(a,r,t,h,s.eff_props);if(o){if(h.ipipe&&e&&e.output&&(o.input=e.output),o.prepareOutput(),!h.ihide&&o.output){let t={fliph:h.ifliph,flipv:h.iflipv};i(o.output,h.urect,t)}return o}},t.prototype.set_background=function(){let t=this.a_.ui.back_color;if(t){if(t<0){let e=this.patch_index1(-t);e&&e.avg_color&&(t=e.avg_color)}background(t)}else clear()};class h{constructor(t){this.period=t,this.restart()}restart(){this.period_time=(new Date).getTime()}lapse(){return((new Date).getTime()-this.period_time)/1e3}check(t){let e=(new Date).getTime(),i=(e-this.period_time)/1e3;return this.period>=0&&i>this.period?(this.period_time=e,t&&t(),1):0}}t.prototype.PeriodTimer=h,t.prototype.createEffect=async function({eff_label:t,imedia:e,urect:i,props:s,eff_spec:h}){let a,r;h||(h={eff_label:t,imedia:e,urect:i}),a=this.mediaDivAt(e),a&&(r=a.capture);let o=await this.effectMeta_find(t),n=this.factory_prop_inits(o.factory),p=Object.assign(n,{videoKit:this,eff_spec:h,input:r,media:a},s);return new o.factory(p)},t.prototype.layerCopyInput=function(t,{imedia:e,input:i,urect:s,fitWidth:h}){if(void 0!==e){let t=this.mediaDivAt(e);if(!t||!t.ready("layerCopyInput"))return 0;i=t.capture}else if(!i)return ui_log("layerCopyInput input MISSING",i),0;let a=i.width,r=i.height,{x0:o,y0:n,width:p,height:l}=s;t.copy(i,0,0,1,1,o,n,p,l);let _=l*(a/r),c=Math.floor(o+(p-_)/2),d=l;return h&&(c=o,_=p,d=p*(r/a),d>l&&(r*=l/d,d=l)),t.copy(i,0,0,a,r,c,n,_,d),1},t.prototype.layerCopyEffect=function(t,e){if(!t)return void ui_log("layerCopyEffect no layer");if(!e)return void ui_log("layerCopyEffect no eff");if(e.prepareOutput(),!e.output)return;let i=e.output,s=i.width,h=i.height,{x0:a,y0:r,width:o,height:n}=e.eff_spec.urect,p=n*(s/h),l=Math.floor(a+(o-p)/2);t.copy(i,0,0,s,h,l,r,p,n)},t.prototype.prepareOutput=function(t){t.prepareOutput()},t.prototype.deinitEffect=function(t){this.patch_inst_deinit(t)},t.prototype.ouputToCanvas=function(t){if(t.output){let e=t.eff_spec,s={fliph:e.ifliph,flipv:e.iflipv};i(t.output,t.eff_spec.urect,s)}},t.prototype.mediaDivCount=function(){return this.a_.mediaDivs.length},t.prototype.mediaDivLiveIndex=function(){return ui_log("mediaDivLiveIndex lastMediaDivIndex",this.a_.lastMediaDivIndex),this.a_.lastMediaDivIndex||0},t.prototype.mediaDivAt=function(t){return this.a_.mediaDivs[t]},t.prototype.mouse_event_check=function(t){t.mouseDragged&&(this.mouseDragged_inst=t),t.mouseReleased&&(this.mouseReleased_inst=t)},t.prototype.mouseDragged=function(){this.mouseDragged_inst&&this.mouseDragged_inst.mouseDragged()},t.prototype.mouseReleased=function(){this.mouseReleased_inst&&this.mouseReleased_inst.mouseReleased()};let a={warning:0};window.dice=a,a.dapi=function(t,e,i){a.debug&&ui_log("dice arg="+t+" arg2="+JSON.stringify(e));var s=t;if(void 0!==e&&((s={})[t]=e),"string"==typeof i)s._result_str=i;else if("function"==typeof i){var h=a.result_rtag+"";s._result_rtag=h,a.result_rtag++,a.result_funcs[h]=i}window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.dice?window.webkit.messageHandlers.dice.postMessage(s):a.warning&&ui_log("dice opt="+JSON.stringify(s))},a.result_funcs={},a.result_rtag=1,a.result_rvalue=function(t,e){var i=a.result_funcs[t];i?(delete a.result_funcs[t],i(e)):ui_log("dice.result_rvalue missing rtag="+t)},a.startTime=window.performance.now(),t.prototype.effectMeta_init=function(){this.a_.effectMetaDict={};let t=0;for(let e of this.a_.effectMetas)this.a_.effectMetaDict[e.label]=e,e.index=t,t++},t.prototype.effectMeta_find=async function(t){t||(ui_log("effectMeta_find no label",t),t="show");let e=this.a_.effectMetaDict[t];if(e||(ui_log("effectMeta_find label not found",t),e=this.a_.effectMetas[0]),!e.factory&&this.import_effect_handler)try{ui_log("effectMeta_find import_effect effMeta",e),e.factory=await this.import_effect(e)}catch(t){ui_log("effectMeta_find err",t),e.factory=r}return e.factory||(e=this.a_.effectMetas[0]),e},t.prototype.import_effect=function(t){return ui_log("p5videoKit import_effect label",t.label),ui_log("p5videoKit import_effect import_path",t.import_path),new Promise(((e,i)=>{this.import_effect_handler(t).then((i=>{ui_log("import_effect label",t.label,"module",i),e(i.default)})).catch((e=>{ui_log("import_effect label",t.label,"\n err",e),i(e)}))}))},t.prototype.factory_prop_inits=function(t,e={}){let i=t.meta_props,s=Object.assign({},e,{videoKit:this});for(let t in i){let e=i[t];"_"===t.substring(0,1)&&(t=t.substring(1)),Array.isArray(e)&&(s[t]=e[0])}return s};class r{static meta_props=[];constructor(){}prepareOutput(){}}t.prototype.patch_inst_create=async function(t,e,i,s,h){let a=await this.effectMeta_find(t);if(!a)return void ui_log("patch_inst_create !!@ No eff_label",t);if(!a.factory)return void ui_log("patch_inst_create !!@ No factory",a);let r=this.a_.mediaDivs[e];if(r){if(!r.ready("patch_inst")){let t=this.a_.patch_instances[i];return void(t&&t.livem_step&&(ui_log("livem_step imedia",e),t.livem_step()))}}else;let o=this.a_.patch_instances[i];if(o)r&&(o.media=r,o.input=r.capture);else{if(!r)return this.a_.mediaDivs.length>1?void ui_log("Exit - NO media for init imedia",e):void ui_log("Exit until media ready",e);let t=r.capture,n=this,p=Object.assign({videoKit:n,eff_spec:s,input:t,media:r},h);o=new a.factory(p),this.a_.patch_instances[i]=o,this.mouse_event_check(o)}return o},t.prototype.patch_add=function(t){t.eff_spec.ipatch=this.a_.ui.patches.length,this.a_.ui.patches.push(t),this.ui_patch_update(t),this.ui_refresh(),this.pad_layout_update()},t.prototype.patch_remove_ipatch=function(t){this.patch_remove_at(t)},t.prototype.patch_remove_at=function(t){this.patch_inst_update(t),this.a_.ui.patches.splice(t,1),this.a_.patch_instances.splice(t,1),this.ui_div_empty("patch_"+t),this.ui_patch_update(),this.ui_refresh(),this.pad_layout_update()},t.prototype.patch_update_effIndex=function(t,e){let i=t.eff_spec,s=i.ipatch;i.eff_label=this.a_.effectMetas[e].label,this.a_.ui.patches[s]={eff_spec:i,eff_props:{}},this.ui_patch_update(t),this.ui_patch_eff_panes()},t.prototype.patch_instances_clear_all=function(){for(let t=0;t<this.a_.patch_instances.length;t++)this.patch_inst_update(t);this.a_.patch_instances=[]},t.prototype.patch_inst_update=function(t){let e=this.a_.patch_instances[t];this.patch_inst_deinit(e)},t.prototype.patch_inst_deinit=function(t){t&&(t.deinit?t.deinit():t.output&&t.output.remove&&t.output.remove())},t.prototype.recordVideo=function(t){this.recVideoInst&&this.recVideoInst.record_flush(),this.recVideoInst=new o(t),this.recVideoInst.videoKit=this,this.recVideoInst.record_start()};class o{constructor(t){Object.assign(this,t),this.chunks=[],this.recording=0,this.end_time=Number.MAX_SAFE_INTEGER;let e=(this.sourceElt||document.querySelector("canvas")).captureStream(this.record_fps);this.recorder=new MediaRecorder(e),this.recorder.ondataavailable=t=>{t.data.size&&this.chunks.push(t.data)},this.recorder.onstop=t=>{this.exportVideo()},this.requestID=window.requestAnimationFrame((t=>this.record_check_done(t)))}record_check_done(t){if(this.recording){let t=(Date.now()-this.start_time)/100;t=Math.trunc(t)/10,t!=this.lapseSec&&(this.videoKit.ui_message("Recording "+t+" secs"),this.lapseSec=t)}this.end_time<Date.now()?(this.end_time=Number.MAX_SAFE_INTEGER,this.record_stop(),window.cancelAnimationFrame(this.requestID),this.videoKit.recVideoInst=null,this.doneFunc&&this.doneFunc()):this.requestID=window.requestAnimationFrame((t=>this.record_check_done(t)))}record_flush(){ui_log("RecordVideo record_flush",this.requestID,this.recording),this.requestID&&window.cancelAnimationFrame(this.requestID),this.recording&&this.recorder.stop()}record_start(){this.recorder.start(),this.recording=1,this.start_time=Date.now(),this.end_time=Date.now()+1e3*this.duration,this.lapseSec=-1}record_stop(){this.recording&&(this.recorder.stop(),this.videoKit.ui_message("")),this.recording=0}exportVideo(){let t=new Blob(this.chunks,{type:"video/webm"}),e=URL.createObjectURL(t),i=document.createElement("a");document.body.appendChild(i),i.style="display: none",i.href=e,i.download=this.save_name+".webm",i.click(),window.URL.revokeObjectURL(e),i.remove()}}class n{static meta_props={factor:[10,1,5,10,20,40,50,100,200,500,1e3,2e3,3e3,5e3,1e4],mirror:[0,1]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.mirror?this.bestill_render_mirror():this.bestill_prepareOutput()}init(){this.stillf=[this.factor,this.factor,this.factor];let t=this.input;this.output=createImage(t.width,t.height),this.srcimage=createImage(this.output.width,this.output.height),this.buf=[]}bestill_prepareOutput(){if(!this.inited)return void this.buf_init();let{output:t,srcimage:i,buf:s}=this;e({to:i,from:this.input}),i.loadPixels(),t.loadPixels();let h=this.stillf[0],a=this.stillf[1],r=this.stillf[2],o=h-1,n=a-1,p=r-1,l=i.width,_=i.height;for(let e=0;e<_;e+=1)for(let _=0;_<l;_+=1){let c=4*(l*e+_);s[c+0]=(s[c+0]*o+i.pixels[c+0])/h,s[c+1]=(s[c+1]*n+i.pixels[c+1])/a,s[c+2]=(s[c+2]*p+i.pixels[c+2])/r,t.pixels[c+0]=s[c+0],t.pixels[c+1]=s[c+1],t.pixels[c+2]=s[c+2]}t.updatePixels()}bestill_render_mirror(){if(!this.inited)return void this.buf_init();let{output:t,srcimage:i,buf:s}=this;e({to:i,from:this.input}),i.loadPixels(),t.loadPixels();let h=this.stillf[0],a=this.stillf[1],r=this.stillf[2],o=h-1,n=a-1,p=r-1,l=i.width,_=i.height;for(let e=0;e<_;e+=1)for(let _=0;_<l;_+=1){let c=4*(l*e+_),d=4*(l*e+(l-1-_));s[c+0]=(s[c+0]*o+i.pixels[c+0])/h,s[c+1]=(s[c+1]*n+i.pixels[c+1])/a,s[c+2]=(s[c+2]*p+i.pixels[c+2])/r,t.pixels[d+0]=s[c+0],t.pixels[d+1]=s[c+1],t.pixels[d+2]=s[c+2]}t.updatePixels()}buf_init(){this.inited=1;let{buf:t,output:i}=this,s=i.width,h=i.height;e({to:i,from:this.input}),i.loadPixels();for(let e=0;e<h;e+=1)for(let h=0;h<s;h+=1){let a=4*(s*e+h);t[a+0]=i.pixels[a+0],t[a+1]=i.pixels[a+1],t[a+2]=i.pixels[a+2]}}}class p{static meta_props={ncell:[16,32,64,128,256,512],back_color:[0,51,255,-1],src_color:[255,0],fill:[1,0],invert:[1,0],shape:["rect","circle","pix"]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.draw_it()}init(){let{width:t,height:e}=this.input;this.src=createImage(t,e),this.output=createGraphics(t,e),this.xstep=Math.floor(t/this.ncell),this.ystep=this.xstep}draw_it(){e({to:this.src,from:this.input});let t=this.output;this.back_color<0?t.clear():t.background(this.back_color),t.noStroke();let i="rect"==this.shape,s="circle"==this.shape,{width:h,height:a}=this.src;this.fill||t.fill(this.src_color);for(let e=0;e<a;e+=this.ystep)for(let a=0;a<h;a+=this.xstep){let h=this.src.get(a,e),r=(h[0]+h[1]+h[2])/3;this.invert&&(r=255-r);let o=map(r,0,255,0,this.xstep);this.fill&&t.fill(h);let n=a+(this.xstep-o)/2,p=e+(this.ystep-o)/2;i?t.rect(n,p,o,o):s?t.ellipse(n,p,o,o):t.image(this.src,n,p,o,o,a,e,this.xstep,this.ystep)}}}class l{static meta_props={per_frame:[5,10,50,100,200,1e3],ntry:[50,100,200,500,1e3,2e3],period:[0,1,2,5,10,20,30,60]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){e({to:this.src,from:this.input}),this.output.clear(),this.period_timer.check((()=>{this.full=this.fullPending})),this.draw_circles()}init(){this.period_timer=new h(this.period),this.src=createImage(this.input.width,this.input.height),this.output=createGraphics(this.input.width,this.input.height),this.circles=[],this.output.noStroke(),this.full=0,this.fullPending=0}draw_circles(){let t=this.circles,e=0;for(var i=0;i<t.length;i++){var s=t[i];if(s.show(),s.growing){s.grow();for(var h=0;h<t.length;h++){var a=t[h];if(a!=s)dist(s.x,s.y,a.x,a.y)-1<s.r+a.r&&(s.growing=!1)}s.growing&&(s.growing=!s.edges())}else this.full&&(s.shrink(),s.r<=0&&e++)}this.circles.length==e&&(this.full=0,this.fullPending=0,this.circles=[],this.output.clear());let r=this.per_frame;var o=0;if(!this.full)for(i=0;i<this.ntry&&(this.addCircle()&&o++,o!=r);i++);o<1&&(this.fullPending=1)}addCircle(){let t=this.circles,e=this.output,i=e.width,s=e.height;var h=new _(random(i),random(s),1);h.eff=this;for(var a=0;a<t.length;a++){var r=t[a];if(dist(h.x,h.y,r.x,r.y)<r.r+4){h=void 0;break}}return!!h&&(t.push(h),!0)}}class _{constructor(t,e,i){this.growing=!0,this.x=t,this.y=e,this.r=i,this.delta=.2}edges(){let t=this.eff.output,e=t.width,i=t.height;return this.r>e-this.x||this.r>this.x||this.r>i-this.y||this.r>this.y}grow(){this.r+=this.delta}shrink(){this.r-=this.delta/5,this.r<0&&(this.r=0)}show(){let t=this.eff.output,e=this.eff.src.get(this.x,this.y);t.fill(e),t.ellipse(this.x,this.y,2*this.r)}}var c;c={exports:{}},function(){function t(e){if(!(this instanceof t))return new t(e);this.points=e||[]}function e(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(e[1]-t[1])*(i[0]-t[0])>0}function i(t,i){return e(t,i.dest,i.orig)}function s(t,i){return e(t,i.orig,i.dest)}function h(t,e){return i(t.dest,e)}function a(t,e,i,s){if(t[0]===s[0]&&t[1]===s[1]||e[0]===s[0]&&e[1]===s[1]||i[0]===s[0]&&i[1]===s[1])return!1;var h=t[0]*t[0]+t[1]*t[1],a=e[0]*e[0]+e[1]*e[1],r=i[0]*i[0]+i[1]*i[1],o=s[0]*s[0]+s[1]*s[1],n=r-o,p=i[1]-s[1],l=i[1]*o-r*s[1],_=i[0]-s[0],c=i[0]*o-r*s[0],d=i[0]*s[1]-i[1]*s[0];return t[0]*(e[1]*n-a*p+l)-t[1]*(e[0]*n-a*_+c)+h*(e[0]*p-e[1]*_+d)-e[0]*l+e[1]*c-a*d>1}function r(t,e,i){this.onext=t,this.rot=e,this.orig=i,this.mark=!1}function o(t,e){var i=new r(null,null,t),s=new r(null,null,null),h=new r(null,null,e),a=new r(null,null,null);return i.onext=i,h.onext=h,s.onext=a,a.onext=s,i.rot=s,s.rot=h,h.rot=a,a.rot=i,i}function n(t,e){var i=t.onext.rot,s=e.onext.rot,h=t.onext,a=s.onext,r=i.onext;t.onext=e.onext,e.onext=h,i.onext=a,s.onext=r}function p(t,e){var i=o(t.dest,e.orig);return n(i,t.lnext),n(i.sym,e),i}function l(t){n(t,t.oprev),n(t.sym,t.sym.oprev)}function _(t){var r,c,d,u;if(2===t.length)return{le:r=o(t[0],t[1]),re:r.sym};if(3===t.length)return r=o(t[0],t[1]),c=o(t[1],t[2]),n(r.sym,c),e(t[0],t[1],t[2])?(d=p(c,r),{le:r,re:c.sym}):e(t[0],t[2],t[1])?{le:(d=p(c,r)).sym,re:d}:{le:r,re:c.sym};for(var g=Math.ceil(t.length/2),f=_(t.slice(0,g)),m=_(t.slice(g)),y=f.le,v=f.re,j=m.le,x=m.re;;)if(s(j.orig,v))v=v.lnext;else{if(!i(v.orig,j))break;j=j.rprev}var w=p(j.sym,v);for(v.orig===y.orig&&(y=w.sym),j.orig===x.orig&&(x=w);;){var b=w.sym.onext;if(h(b,w))for(;a(w.dest,w.orig,b.dest,b.onext.dest);)u=b.onext,l(b),b=u;var k=w.oprev;if(h(k,w))for(;a(w.dest,w.orig,k.dest,k.oprev.dest);)u=k.oprev,l(k),k=u;if(!h(b,w)&&!h(k,w))break;w=!h(b,w)||h(k,w)&&a(b.dest,b.orig,k.orig,k.dest)?p(k,w.sym):p(w.sym,b.sym)}return{le:y,re:x}}t.prototype={triangulate:function(){var t=this.points;t.sort((function(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}));for(var e=t.length-1;e>=1;e--)t[e][0]===t[e-1][0]&&t[e][1]===t[e-1][1]&&t.splice(e,1);if(t.length<2)return{};for(var i=_(t).le,h=[],a=0,r=[i];s(i.onext.dest,i);)i=i.onext;var o=i;do{r.push(o.sym),o.mark=!0,o=o.lnext}while(o!==i);do{var n=r[a++];if(!n.mark){o=n;do{h.push(o.orig),o.sym.mark||r.push(o.sym),o.mark=!0,o=o.lnext}while(o!=n)}}while(a<r.length);return h}},r.prototype={get sym(){return this.rot.rot},get dest(){return this.sym.orig},get rotSym(){return this.rot.sym},get oprev(){return this.rot.onext.rot},get dprev(){return this.rotSym.onext.rotSym},get lnext(){return this.rotSym.onext.rot},get lprev(){return this.onext.sym},get rprev(){return this.sym.onext}},t.prototype.ccw=e,t.prototype.rightOf=i,t.prototype.leftOf=s,t.prototype.inCircle=a,c.exports=t,globalThis.Delaunay=t}();class d{static meta_props={dcell:[50,5,10,20,30,40,50,100],period:[30,0,.5,1,2,5,10,20,30,60],type:["triangle","rect","circle","ellipse"],alpha:[255,230,180,100,10,5,2,1],gray:[0,1]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){for(e({to:this.img,from:this.input});!this.draw_step(););this.period_timer.check((()=>{this.init_points()}))}init(){this.period_timer=new h(this.period);let t=this.input.width,e=this.input.height;this.img=createImage(t,e),this.output=createGraphics(t,e),this.output.noStroke(),this.index=0,this.cindex=2,this.init_points(this)}init_points(){let t=this.input.width,e=this.input.height,i=[],s=this.dcell*this.dcell;for(let h=0;h<s;h++){let s=Math.floor(random(0,t)),h=Math.floor(random(0,e));i.push([s,h])}i.push([0,0]),i.push([t,0]),i.push([0,e]),i.push([t,e]);let h=new Delaunay(i);switch(this.points=h.triangulate(),this.type){case"circle":this.drawf=this.draw_circle;break;case"ellipse":this.drawf=this.draw_ellipse;break;case"rect":this.drawf=this.draw_rect;break;default:this.drawf=this.draw_triangle}}draw_step(){let t=this.output,e=this.img,i=this.points,[s,h]=i[this.index],[a,r]=i[this.index+1],[o,n]=i[this.index+2],[p,l]=i[this.index+this.cindex],_=e.get(p,l);if(_[3]=this.alpha,this.gray){let t=(_[0]+_[1]+_[3])/3;_[0]=t,_[1]=t,_[2]=t}return t.fill(_),this.drawf(t,s,h,a,r,o,n),this.index=(this.index+3)%i.length,0==this.index?1:0}draw_circle(t,e,i,s,h,a,r){let o=min(e,s,a),n=min(i,h,h),p=max(e,s,a)-o,l=max(i,h,r)-n,_=max(p,l);t.circle(o+p/2,n+l/2,_)}draw_ellipse(t,e,i,s,h,a,r){let o=min(e,s,a),n=min(i,h,h),p=max(e,s,a)-o,l=max(i,h,r)-n;t.ellipse(o+p/2,n+l/2,p,l)}draw_rect(t,e,i,s,h,a,r){let o=min(e,s,a),n=min(i,h,h),p=max(e,s,a),l=max(i,h,r);t.rect(o,n,p-o,l-n)}draw_triangle(t,e,i,s,h,a,r){t.triangle(e,i,s,h,a,r)}}class u{static meta_props={threshold:[16,1,2,4,8,16,32,64,128,200],period:[0,0,.5,1,2,5,10,20,30,60],back_color:["clear","rgb(0,0,0)","rgb(50,50,50)","rgb(100,100,100)","rgb(200,200,200)","rgb(255,255,255)"],smooth:[0,10,1,5,10,50,100,200],hold:[0,.001,.005,.01,.5,1,5,10,20]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.diff_prepareOutput(),this.period&&this.period_timer.check((()=>{this.inited=0,this.iimage=0}))}init(){this.period_timer=new h(this.period);let t=createImage(this.input.width,this.input.height),e=createImage(t.width,t.height);if(this.diffimage=createImage(t.width,t.height),this.hold?(this.hold_level=this.hold/100,this.output=createImage(t.width,t.height)):this.output=this.diffimage,this.images=[t,e],this.iimage=0,"clear"===this.back_color)this.back_color_arr=[0,0,0,0];else{let t=color(this.back_color);this.back_color_arr=[],this.back_color_arr[0]=red(t),this.back_color_arr[1]=green(t),this.back_color_arr[2]=blue(t),this.back_color_arr[3]=255}this.smooth&&this.smooth_init(),this.maxdiff=t.width*t.height}diff_prepareOutput(){if(!this.inited)return void this.image_init();let t=this.images[this.iimage];e({to:t,from:this.input}),this.iimage=(this.iimage+1)%2;let i=this.images[this.iimage],s=this.diffimage;t.loadPixels(),i.loadPixels(),s.loadPixels();let h,a=t.width,r=t.height,o=3*this.threshold,n=this.back_color_arr,p=0;for(let e=0;e<r;e+=1)for(let r=0;r<a;r+=1){let l=4*(a*e+r);h=Math.abs(i.pixels[l+0]-t.pixels[l+0])+Math.abs(i.pixels[l+1]-t.pixels[l+1])+Math.abs(i.pixels[l+2]-t.pixels[l+2]),h>o?(s.pixels[l+0]=t.pixels[l+0],s.pixels[l+1]=t.pixels[l+1],s.pixels[l+2]=t.pixels[l+2],s.pixels[l+3]=255,p++):(s.pixels[l+0]=n[0],s.pixels[l+1]=n[1],s.pixels[l+2]=n[2],s.pixels[l+3]=n[3])}if(s.updatePixels(),this.hold){round(p/this.maxdiff,4)>this.hold_level&&function({to:t,from:e}){t.loadPixels(),e.loadPixels();let i=t.pixels,s=e.pixels,h=i.length;if(h==s.length){for(;h-- >0;)i[h]=s[h];t.updatePixels()}else ui_log("image_move!!@ lengths differ",h,s.length)}({to:this.output,from:this.diffimage})}this.smooth&&this.smooth_prepareOutput()}image_init(){this.inited=1,e({to:this.images[(this.iimage+1)%2],from:this.input})}smooth_init(){this.bestill=new n({input:this.output,factor:this.smooth})}smooth_prepareOutput(){this.bestill.bestill_prepareOutput(),e({to:this.output,from:this.bestill.output})}}function g(t,e,i){if(!e)return;let s=t.output,h=t.ddraw,a="dots"===h,r="rects"===h,o="tris"===h,n="crop"===h,p="pixd"==h,l=s.width,_=s.height;t.mar_w;let c=_*(t.mar_h/100),d=_/e.height,u="none"===t.align,g="center"===t.align,m="right"===t.align,y=[0,0,0],v=t.avg_index,j=0,x=t.from,w=t.to;w>i.length&&(w=i.length);for(let h=x;h<w;h++){const x=i[h],w=x.scaledMesh;let[b,k]=w[10],[I,z]=w[152];if(b=w[234][0],I=w[454][0],t.box_outter){let t=x.boundingBox;[b,k]=t.topLeft[0],[I,z]=t.bottomRight[0]}let M=b,O=k,D=I-b,S=(_-2*c)/(z-k),P=0,E=c;if(m?P=l-D*S:g?P=(l-D*S)/2:u&&(S=d,M=0,O=0),t.box_rect){let t=(b-M)*S+P,e=(k-O)*S+E,i=(I-M)*S+P,h=(z-O)*S+E;s.stroke(0),s.noFill(),s.rect(t,e,i-t,h-e),s.noStroke()}let C=f.length;if(v||(v=C),t.mask_index&&(C=t.mask_index),t.reveal?(t.nnits+=t.reveal,t.nnits>=f.length?(t.reveal_full&&!t.mesh_done&&t.period_timer.restart(),t.mesh_done=1,t.nnits=f.length):t.mesh_done=0,C=t.nnits):t.mesh_done=1,p){let i=(b-M)*S+P,h=(k-O)*S+E,a=(I-M)*S+P,r=(z-O)*S+E,o=I-b,n=z-k;{let p=t.pixd_img,l=p.height,_=Math.floor(l*(o/n));p.copy(e,b,k,o,n,0,0,_,l);let c=(a-i)/_,d=(r-h)/l;for(let t=0;t<l;t++)for(let e=0;e<_;e++){let a=p.get(e,t),r=(a[0]+a[1]+a[2])/3;s.fill(r),s.rect(i+e*c,h+t*d,c,d),y[0]+=r,y[1]+=r,y[2]+=r,j++}}}else if(n){let t=(b-M)*S+P,i=(k-O)*S+E,h=I-b,a=z-k,r=(I-M)*S+P-t,o=(z-O)*S+E-i;s.copy(e,b,k,h,a,t,i,r,o);for(let t=0;t<C;t+=3){let[i,s]=w[f[t]],h=e.get(i,s);t<v&&(y[0]+=h[0],y[1]+=h[1],y[2]+=h[2],j++)}}else if(a){let i=Math.floor(s.width*(t.slen/100));for(let h=0;h<C;h+=1){let[a,r]=w[f[h]],o=e.get(a,r);o[3]=t.alpha,h<v&&(y[0]+=o[0],y[1]+=o[1],y[2]+=o[2],j++),a=(a-M)*S+P,r=(r-O)*S+E,s.fill(o),s.ellipse(a,r,i,i)}}else if(r){let i=Math.floor(s.width*(t.slen/100));for(let h=0;h<C;h+=1){let[a,r]=w[f[h]],o=e.get(a,r);o[3]=t.alpha,h<v&&(y[0]+=o[0],y[1]+=o[1],y[2]+=o[2],j++),a=(a-M)*S+P,r=(r-O)*S+E,s.fill(o),s.rect(a,r,i,i)}}else if(o){let i=t.constructor.tri_dir,h=0,a=Math.floor(s.width*(t.slen/100));for(let r=0;r<C;r+=1){let[o,n]=w[f[r]],p=e.get(o,n);p[3]=t.alpha,r<v&&(y[0]+=p[0],y[1]+=p[1],y[2]+=p[2],j++);let l=i[h];h=(h+1)%i.length;let[_,c]=l,d=(o-M)*S+P,u=(n-O)*S+E,g=d+a*_[0],m=u+a*_[1],x=d+a*c[0],b=u+a*c[1];s.fill(p),s.triangle(d,u,g,m,x,b)}}else for(let i=0;i<C;i+=3){let[h,a]=w[f[i]],[r,o]=w[f[i+1]],[n,p]=w[f[i+2]],l=e.get(h,a);l[3]=t.alpha,i<v&&(y[0]+=l[0],y[1]+=l[1],y[2]+=l[2],j++),h=(h-M)*S+P,a=(a-O)*S+E,r=(r-M)*S+P,o=(o-O)*S+E,n=(n-M)*S+P,p=(p-O)*S+E,s.fill(l),s.triangle(h,a,r,o,n,p)}}j>0&&(t.avg_color[0]=int(y[0]/j),t.avg_color[1]=int(y[1]/j),t.avg_color[2]=int(y[2]/j))}let f=[10,338,337,10,337,151,109,10,108,109,108,69,338,297,299,338,299,337,67,109,69,67,69,104,297,332,333,297,333,299,103,67,104,103,104,68,332,284,298,332,298,333,108,10,151,108,151,107,108,107,66,337,299,296,337,296,336,69,108,66,69,66,105,299,333,334,299,334,296,151,337,336,151,336,9,54,103,68,54,68,71,284,251,301,284,301,298,104,69,105,104,105,63,333,298,293,333,293,334,68,104,63,68,63,70,298,301,300,298,300,293,21,54,71,21,71,139,251,389,368,251,368,301,66,107,65,66,65,52,296,334,282,296,282,295,105,66,52,105,52,53,334,293,283,334,283,282,336,296,295,336,295,285,107,151,9,107,9,55,107,55,65,9,336,285,9,285,8,63,105,53,63,53,46,293,300,276,293,276,283,71,68,70,71,70,156,301,368,383,301,383,300,65,55,221,65,221,222,295,282,443,295,443,442,52,65,223,52,223,224,282,283,444,282,444,443,53,52,224,53,224,225,283,276,445,283,445,444,70,63,46,70,46,124,300,383,353,300,353,276,285,295,441,285,441,413,55,9,8,55,8,193,55,193,189,8,285,417,8,417,168,46,53,225,46,225,113,276,353,342,276,342,445,162,21,139,162,139,34,389,356,264,389,264,368,223,65,222,223,222,28,223,28,27,443,444,259,443,259,257,224,223,29,224,29,30,444,445,260,444,260,259,222,221,56,222,56,28,442,443,258,442,258,286,225,224,30,225,30,247,445,342,467,445,467,260,139,71,156,139,156,143,368,264,372,368,372,383,441,295,442,441,442,286,441,286,414,221,55,189,221,189,190,221,190,56,156,70,124,156,124,35,383,372,265,383,265,353,27,28,158,27,158,159,257,259,386,257,386,385,28,56,157,28,157,158,258,443,257,258,257,385,258,385,384,29,223,27,29,27,159,29,159,160,259,260,387,259,387,386,124,46,113,124,113,226,353,265,446,353,446,342,168,417,6,417,285,413,417,413,465,417,465,351,193,8,168,193,168,6,193,6,122,30,29,160,30,160,161,260,467,466,260,466,388,56,190,173,56,173,157,286,258,384,286,384,398,159,158,153,159,153,145,386,387,373,386,373,374,113,225,247,113,247,130,342,446,359,342,359,467,158,157,153,385,386,380,160,159,144,387,260,388,387,388,390,413,441,414,413,414,463,413,463,464,189,193,245,189,245,244,189,244,243,157,173,154,157,154,153,384,385,380,384,380,381,161,160,163,388,466,249,247,30,246,247,246,33,467,359,263,467,263,466,246,30,161,246,161,7,190,189,243,190,243,133,190,133,173,414,286,398,414,398,362,173,133,155,173,155,154,398,384,381,398,381,382,263,249,466,130,247,33,359,255,263,7,33,246,249,339,390,249,390,388,226,113,130,446,261,255,446,255,359,133,243,112,133,112,155,362,398,382,163,7,161,390,254,373,390,373,387,25,226,130,25,130,33,25,33,7,255,448,339,255,339,249,255,249,263,243,244,233,243,233,112,463,414,362,463,362,341,463,341,453,155,112,154,35,124,226,265,340,261,265,261,446,464,463,453,154,112,26,381,380,256,144,163,160,144,159,145,373,253,374,244,245,188,244,188,128,244,128,233,143,156,35,372,345,340,372,340,265,153,154,26,153,26,22,380,386,374,380,374,252,380,252,256,341,362,382,341,382,381,341,381,256,110,25,7,110,7,163,339,449,254,339,254,390,112,233,232,112,232,26,465,413,464,465,464,357,465,357,412,34,139,143,264,447,345,264,345,372,245,193,122,245,122,188,145,153,22,6,417,351,6,351,197,127,162,34,356,454,447,356,447,264,26,232,22,351,465,412,351,412,419,122,6,197,122,197,196,24,110,163,24,163,144,24,144,23,254,450,253,254,253,373,453,341,452,233,128,121,233,121,232,261,346,448,261,448,255,31,35,226,31,226,25,23,144,145,23,145,22,253,451,252,253,252,374,452,341,256,452,256,252,357,464,453,357,453,350,357,350,343,412,357,343,412,343,399,128,188,114,128,114,121,188,122,196,188,196,174,188,174,114,448,347,449,448,449,339,228,31,25,228,25,110,451,350,452,451,452,252,231,23,22,231,22,232,350,277,343,350,453,452,121,231,232,449,348,450,449,450,254,229,228,110,229,110,24,229,24,230,450,349,451,450,451,253,230,24,23,230,23,231,340,346,261,111,143,35,111,35,31,114,174,217,197,351,419,197,419,195,419,412,399,419,399,248,196,197,195,196,195,3,349,329,277,349,277,350,349,350,451,120,230,231,120,231,121,399,343,437,399,437,456,174,196,3,174,3,236,174,236,217,277,355,437,277,437,343,47,120,121,47,121,114,47,114,217,346,352,280,346,280,347,346,347,448,117,111,31,117,31,228,116,34,143,116,143,111,116,111,117,345,352,346,345,346,340,348,330,329,348,329,349,348,349,450,119,229,230,119,230,120,437,420,456,347,280,330,347,330,348,347,348,449,118,117,228,118,228,229,118,229,119,227,127,34,227,34,116,227,116,123,447,366,352,447,352,345,195,419,248,195,248,5,248,399,456,248,456,281,3,195,5,3,5,51,329,371,355,329,355,277,100,119,120,100,120,47,100,47,126,236,3,51,236,51,134,234,127,227,234,227,137,454,323,366,454,366,447,355,429,420,355,420,437,126,47,217,126,217,198,420,360,363,420,363,456,198,217,236,198,236,134,330,425,266,330,266,371,330,371,329,101,118,119,101,119,100,101,100,142,5,248,281,5,281,4,51,5,4,51,4,45,281,456,363,281,363,275,363,440,275,134,51,45,371,266,358,371,358,429,371,429,355,142,100,126,142,126,209,429,358,279,429,279,360,429,360,420,209,126,198,209,198,131,131,198,134,131,134,220,360,279,344,360,344,440,360,440,363,123,116,117,123,117,50,352,376,411,352,411,280,4,281,275,4,275,274,4,274,1,275,457,274,45,4,44,220,134,45,220,45,237,440,344,438,440,438,457,440,457,275,280,411,425,280,425,330,50,117,118,50,118,101,50,101,36,279,278,344,49,209,131,49,131,115,36,101,142,36,142,129,266,423,358,115,131,220,115,220,218,137,227,123,137,123,147,366,401,376,366,376,352,237,45,44,237,44,241,331,294,278,331,278,279,102,129,49,102,49,48,44,4,1,438,392,309,438,309,459,438,459,457,278,439,344,48,49,115,218,220,237,218,237,239,358,423,294,358,294,331,358,331,279,129,142,209,129,209,49,239,237,238,459,309,458,459,458,457,79,218,239,79,239,238,309,250,458,439,455,392,439,392,438,439,438,344,219,48,115,219,115,218,93,234,137,93,137,177,323,361,401,323,401,366,125,241,44,125,44,1,354,370,19,354,19,1,354,1,274,19,125,1,241,20,238,241,238,237,461,354,274,461,274,457,294,327,455,294,455,439,294,439,278,64,129,102,64,102,48,64,48,219,458,461,457,166,219,218,166,218,79,166,79,60,392,290,309,455,460,289,455,289,392,235,64,219,235,219,166,425,427,426,425,426,423,425,423,266,205,50,36,205,36,203,59,235,166,59,166,75,289,460,305,289,305,392,20,60,79,20,79,238,250,462,461,250,461,458,203,36,129,203,129,64,203,64,98,423,426,391,423,391,327,423,327,294,242,99,20,242,20,241,242,241,125,462,326,370,462,370,354,462,354,461,141,242,125,141,125,19,141,19,94,370,2,94,370,94,19,75,166,60,305,328,290,305,290,392,460,391,393,460,393,328,460,328,305,240,98,235,240,235,59,240,59,75,290,328,250,290,250,309,327,391,460,327,460,455,98,64,235,147,123,187,376,433,411,99,240,75,99,75,60,99,60,20,328,393,326,328,326,462,328,462,250,411,427,425,187,123,50,187,50,205,97,99,242,97,242,141,97,141,2,326,164,2,326,2,370,2,141,94,206,205,203,206,203,165,426,436,322,426,322,391,177,137,147,177,147,213,401,435,433,401,433,376,164,267,0,164,97,2,393,269,267,393,267,164,393,164,326,167,240,99,167,99,97,167,97,164,427,434,432,427,432,436,427,436,426,207,187,205,207,205,206,391,322,270,391,270,269,391,269,393,165,203,98,165,98,240,165,240,167,92,206,165,92,165,40,92,40,185,322,410,409,322,409,270,132,93,177,132,177,215,361,288,435,361,435,401,436,287,410,436,410,322,216,207,206,216,206,92,216,92,186,213,147,187,433,416,411,37,167,164,37,164,0,37,0,72,267,303,302,267,302,0,0,302,11,39,165,167,39,167,37,39,37,73,269,270,304,269,304,303,269,303,267,410,291,409,186,92,185,72,0,11,72,11,38,302,271,268,302,268,11,40,165,39,40,39,74,40,74,183,270,409,408,270,408,407,73,37,72,73,72,41,303,304,272,303,272,271,303,271,302,74,39,73,74,73,42,74,42,191,304,270,407,304,407,415,304,415,272,185,40,184,185,184,62,409,292,408,12,38,11,268,312,12,268,12,11,41,72,38,271,272,310,184,40,183,184,183,78,408,308,407,42,73,41,42,41,80,215,177,213,435,367,433,192,213,187,192,187,207,416,364,434,416,434,427,416,427,411,183,74,191,183,191,78,13,82,12,191,42,88,80,88,42,81,179,178,81,178,41,81,41,38,82,86,87,82,87,38,82,38,12,312,15,14,312,14,13,312,13,12,311,316,317,311,317,268,311,268,271,310,403,402,310,402,271,415,318,272,78,62,184,308,325,324,308,324,415,308,415,407,76,185,62,306,375,292,306,292,409,292,307,308,292,308,408,61,186,185,61,185,76,291,375,306,291,306,409,178,80,41,87,81,38,14,82,13,317,312,268,402,311,271,318,310,272,95,78,191,95,191,88,324,319,318,324,318,415,287,273,291,287,291,410,57,216,186,57,186,61,96,77,78,96,78,95,325,320,319,325,319,324,89,96,95,89,95,88,89,88,80,319,403,310,319,310,318,432,422,287,432,287,436,212,207,216,212,216,57,86,179,81,86,81,87,316,15,312,316,312,317,179,89,80,179,80,178,403,315,316,403,316,311,403,311,402,15,85,86,15,86,82,15,82,14,77,146,62,77,62,78,307,321,325,307,325,308,146,61,76,146,76,62,375,321,307,375,307,292,90,91,96,90,96,89,320,405,404,320,404,319,214,192,207,214,207,212,434,430,422,434,422,432,180,90,89,180,89,179,404,315,403,404,403,319,85,181,180,85,180,179,85,179,86,315,16,15,315,15,316,16,85,15,91,146,77,91,77,96,321,405,320,321,320,325,43,57,61,43,61,146,273,335,375,273,375,291,58,132,215,288,397,435,181,91,90,181,90,180,405,314,315,405,315,404,84,181,85,84,85,16,314,18,17,314,17,16,314,16,315,17,84,16,138,215,213,138,213,192,367,365,364,367,364,416,367,416,433,202,214,212,202,212,57,202,57,43,422,424,273,422,273,287,106,43,146,106,146,91,335,406,321,335,321,375,182,106,91,182,91,181,406,313,405,406,405,321,210,135,214,210,214,202,210,202,204,430,431,424,430,424,422,313,200,18,313,18,314,313,314,405,83,182,181,83,181,84,135,138,192,135,192,214,364,394,430,364,430,434,204,202,43,204,43,106,424,418,335,424,335,273,18,83,84,18,84,17,172,58,215,172,215,138,397,365,367,397,367,435,194,204,106,194,106,182,418,421,406,418,406,335,211,210,204,211,204,194,431,262,418,431,418,424,201,194,182,201,182,83,421,199,200,421,200,313,421,313,406,169,136,135,169,135,210,169,210,211,394,395,431,394,431,430,200,201,83,200,83,18,136,172,138,136,138,135,365,379,394,365,394,364,32,211,194,32,194,201,262,428,421,262,421,418,170,169,211,170,211,32,395,369,262,395,262,431,208,32,201,428,199,421,199,208,201,199,201,200,150,136,169,150,169,170,379,378,395,379,395,394,140,170,32,140,32,208,369,396,428,369,428,262,149,150,170,149,170,140,378,400,369,378,369,395,171,140,208,171,208,199,396,175,199,396,199,428,175,171,199,176,149,140,176,140,171,400,377,396,400,396,369,148,176,171,148,171,175,377,152,175,377,175,396,152,148,175];class m{static meta_props={alpha:[255,230,180,100,10],align:["center","left","right","none"],back_color:[0,1],period:[0,.5,1,2,5,10,20,30,60],hi_rez:[1,0],sticky:[1,0],_reveal:[0,5,10,12,15,20,30,40,50,100,200,500],reveal_full:[1,0],box_outter:[0,1],box_rect:[0,1],_mar_h:[0,0,2,5,10,15,20,30,40],mar_w:[0,0,2,5,10,15,20,30,40],draw:["mesh","dots","rects","tris","crop","pixd","cycle"],draw_mod:[4],slen:[2,1,2,3,4,5,10],_mask_index:[0,1440],avg_index:[0,1440],pixd_n:[8,16,32,64,128],detect_max:[1,10]};static tri_dir=[[[1,1],[-1,-1]],[[-1,-1],[1,-1]],[[1,-1],[1,1]],[[-1,1],[-1,-1]]];constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.facemesh&&(this.facemesh.video=this.video);let t=this.output;t.noStroke(),this.back_color?(t.fill(this.avg_color),t.rect(0,0,t.width,t.height)):t.clear(),this.drawKeypoints(),this.reveal_full&&!this.mesh_done||this.period_timer.check((()=>{this.iperiod++}))}patch_stepper(){ui_log("eff_face_mesh patch_stepper",this.draw_index,"",this.draw),this.draw_index=(this.draw_index+1)%this.draw_mod,this.draw=this.constructor.meta_props.draw[this.draw_index]}init(){this.init_input=this.input,this.cycle_period=0,this.from=0,this.to=this.detect_max,this.mesh_done=0,this.nnits=0,this.iperiod=0,this.iperiod_next=-1,this.period_timer=new h(this.period),this.video=this.input.elt,this.predictions=[],this.iupdate=0,this.videoKit.ui_message("loading model..."),this.facemesh=ml5.facemesh(this.video,(()=>{let t=window.performance.now()-dice.startTime;ui_log("eff_face_mesh load_lapse",t),dice.dapi("stats",{load_lapse:t}),this.videoKit.ui_message("")})),this.facemesh.on("predict",(t=>{"cycle"==this.draw&&(this.iperiod_next=this.iperiod+1),0!==t.length&&this.iperiod!=this.iperiod_next?(this.iupdate++,this.iperiod_next=this.iperiod,this.predictions=t,this.nnits=0,this.frozen=0):this.frozen=1})),this.avg_color=[255,255,255,255];let t=this.input.width,e=this.input.height;ui_log("eff_face_mesh input w",t,"h",e),this.img=createImage(t,e),this.hi_rez&&(t=this.eff_spec.urect.width,e=this.eff_spec.urect.height),ui_log("eff_face_mesh hi_rez",this.hi_rez,"w",t,"h",e),this.output=createGraphics(t,e),this.draw_index=0,t=this.pixd_n,e=this.pixd_n,this.pixd_img=createImage(t,e)}drawKeypoints(){if(this.frozen){if(!this.sticky)return}else e({to:this.img,from:this.init_input});this.ddraw=this.draw,"cycle"===this.ddraw&&(this.ddraw=this.constructor.meta_props.draw[this.draw_index],this.cycle_period!=this.iperiod&&(this.cycle_period=this.iperiod,this.draw_index=(this.draw_index+1)%4)),g(this,this.img,this.predictions)}}class y{static meta_props={ncell:[32,16,32,64,128],margin:[1,2,3],rate:["frame","line","ncell"]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){for(e({to:this.src,from:this.input});!this.draw_one(););this.output.image(this.src,0,0),this.output.image(this.glayer,0,0)}init(){let t=this.input.width,e=this.input.height;this.inw=t,this.inh=e,this.src=createImage(t,e),this.output=createGraphics(t,e),this.glayer=createGraphics(t,e),this.glayer.background(0,0,0,0),this.glayer.noStroke(),this.xs=t/this.ncell,this.ys=e/this.ncell,this.xs>this.ys?this.ys=this.xs:this.xs=this.ys,this.x=0,this.y=0}deinit(){this.output.remove(),this.glayer.remove()}draw_one(){let t=this.glayer,e=this.x+this.margin,i=this.y+this.margin,s=this.src.get(e,i),h=this.xs-this.margin,a=this.ys-this.margin;return t.fill(s),t.rect(e,i,h,a),this.x+=this.xs,this.x>=this.inw?(this.x=0,this.y+=this.ys,this.y>=this.inh?(this.y=0,"frame"===this.rate):"line"===this.rate):"ncell"===this.rate}}class v{static meta_props={ncell:[32,64,128,16],weight:[.5,.6,.7,.8],rate:["frame","line","ncell"],period:[5,10,20,30]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){for(e({to:this.src,from:this.input});!this.draw_one(););this.period_timer.check((()=>{this.period_next()}))}init(){this.period_timer||(this.period_timer=new h(this.period));let t=this.input.width,e=this.input.height;this.inw=t,this.inh=e,this.src||(this.src=createImage(t,e)),this.output=createGraphics(t,e),this.xs=t/this.ncell,this.ys=e/this.ncell,this.xs>this.ys?this.ys=this.xs:this.xs=this.ys,this.x=0,this.y=0,this.rs=[],this.ri=0}period_next(){this.output.clear(),this.x=0,this.y=0,this.rs=[],this.ri=0,this.full=0}draw_one(){let t,e=this.output,i=this.x,s=this.y,h=this.xs,a=this.ys,r=this.src.get(i,s);return e.stroke(r),e.strokeWeight(this.weight*h),this.full?(t=this.rs[this.ri],this.ri++):(t=random(1)>.5,this.rs.push(t)),t?e.line(i,s,i+h,s+a):e.line(i,s+a,i+h,s),this.x+=this.xs,this.x>=this.inw?(this.x=0,this.y+=this.ys,this.y>=this.inh?(this.y=0,this.full=1,this.ri=0,"frame"===this.rate):"line"===this.rate):"ncell"===this.rate}}class j{static meta_props={image_align:["center","none"],_image_url:{style:"width:80%",text_input:"./external/media/webdb/jht/IMG_4491.JPEG"}};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.show_image()}init(){this.output=createGraphics(this.eff_spec.urect.width,this.eff_spec.urect.height),this.load_image()}show_image(){if(!this.img)return;let t="center"===this.image_align;s(this.output,this.img,this.eff_spec.urect,t)}load_image(){let t=this.image_url+"";loadImage(t,(t=>{ui_log("eff_image_url loaded image_url",this.image_url),ui_log("eff_image_url img.width",t.width,"height",t.height),this.img=t}),(()=>{ui_log("eff_image_url load failed image_url",this.image_url)}))}}class x{static meta_props={back_color_patch:[0,1,2,3,4,5,6,7,8,9,10]};constructor(t){Object.assign(this,t)}prepareOutput(){if(this.back_color_patch){let t=this.videoKit.patch_index1(this.back_color_patch);if(t&&t.avg_color){noStroke(),fill(t.avg_color);let e=this.eff_spec.urect;rect(e.x0,e.y0,e.width,e.height)}}}}class w{static meta_props={back_color:[-1,0,51,255,-1],nstep:[5,1,5,10,20,30,50,100,200,400,800,1e3,2e3],len:[6,.5,1,2,4,8,16,32,12,24],max:[-1,1e3,2e3,3e3,5e3,1e4,2e4,3e4,4e4],jump:[0,1],ngrid:[0,2,3,4,8],spacing:[1,.125,.25,.5,2,3,4,8,16,32]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.draw_it()}init(){let{width:t,height:e}=this.input;this.src=createImage(t,e),this.output=createGraphics(t,e);let i=this.output;i.noStroke(),i.angleMode(DEGREES),this.dcount=0,this.x0=t/2,this.y0=e/2,this.nmax=this.max,this.nmax<0&&(this.nmax=t*e),this.a_offset=0,this.off_margin=.1*t}draw_it(){e({to:this.src,from:this.input});let t,i,s,h,a=this.output,{width:r,height:o}=this.input;for(let e=0;e<this.dcount;e++){let n=137.5*e*this.spacing+this.a_offset,p=this.len*sqrt(e),l=p*cos(n)+this.x0,_=p*sin(n)+this.y0,c=this.src.get(l,_);if(a.fill(c),a.ellipse(l,_,this.len,this.len),l<-this.off_margin&&(t=1),l>r+this.off_margin&&(i=1),_<-this.off_margin&&(s=1),_>o+this.off_margin&&(h=1),t&&i&&s&&h)return this.nhit=e,this.nhit_reported||(ui_log("eff_phyllotaxis nhit",this.nhit,"nmax",this.nmax),this.nhit_reported=1),void this.nextCycle()}this.dcount+=this.nstep,this.dcount>this.nmax&&(this.dcount=this.nmax,this.jump&&this.nextCycle())}nextCycle(){if(this.a_offset+=1,this.dcount=0,this.jump){let{width:t,height:e}=this.input;if(0===this.ngrid)this.x0=random(this.off_margin,t-this.off_margin),this.y0=random(this.off_margin,e-this.off_margin);else{let i=t/this.ngrid,s=i*Math.floor(random(0,this.ngrid))+i/2,h=e/this.ngrid,a=h*Math.floor(random(0,this.ngrid))+h/2;this.x0=s,this.y0=a}}}}class b{static meta_props={alpha:[255,230,180,100,10],ndetect:[4,1,2,3],figure_color:[0,1],stroke_weight:[0,1,2,4,8],_points:[0,1],points_size:[10,20,30,40],points_color_offset:[0,1,2,3],_skel:[0,1],skel_weight:[1,5,10,20],skel_color_offset:[0,1,2,3],hflip:[1,0],show_head:[1,0]};constructor(t){Object.assign(this,t),this.init(this)}prepareOutput(){this.poseNet&&(this.poseNet.video=this.video),window.a_poses=this.poses,this.points&&this.drawKeypoints(this.poses),this.skel&&this.drawSkeleton(this.poses),this.drawFigure(this.poses)}init(){if(this.video=this.input.elt,this.poses=[],this.figure_color){let t=this.input.width,e=this.input.height;this.img=createImage(t,e),this.init_input=this.input}this.videoKit.ui_message("loading model...");let t={flipHorizontal:this.hflip,maxPoseDetections:this.ndetect};this.poseNet=ml5.poseNet(this.video,t,(()=>{this.videoKit.ui_message("")})),this.poseNet.on("pose",(t=>{this.poses=t}))}drawFigure(t){this.figure_color&&e({to:this.img,from:this.init_input}),strokeWeight(this.stroke_weight);let i=this.eff_spec.urect,s=i.height;this.px0=i.x0,this.py0=i.y0,this.r1=s/this.input.height;for(let e=0;e<t.length;e++){let i,s=t[e].pose,h=k[e%k.length];if(this.figure_color){let t=s.nose.x,e=s.nose.y;this.hflip&&(t=this.img.width-t),i=this.img.get(t,e)}else i=h;h[3]=this.alpha,i[3]=this.alpha,stroke(h),fill(i),this.draw_pose(s)}}draw_pose(t){this.draw_top(t),this.draw_torso(t)}draw_top(t){let{px0:e,py0:i,r1:s}=this,h=t.rightShoulder.x*s+e,a=t.rightShoulder.y*s+i,r=t.leftShoulder.x*s+e,o=t.leftShoulder.y*s+i,n=t.nose.x*s+e,p=t.nose.y*s+i,l=r-h,_=o-a,c=atan2(_,l);this.hflip&&(c+=Math.PI);let d=h+l/2,u=a+_/2,g=dist(d,u,n,p),f=(t.rightEar.x-t.leftEar.x)*s,m=f/8,y=g/2;push(),translate(d,u),rotate(c),this.show_head&&ellipse(0,-2*y,f,g);quad(0-m,0-y,0+m,0-y,0+2*m,0,0-2*m,0),pop(),this.w=m,this.h=y}draw_torso(t){let{px0:e,py0:i,r1:s,h:h}=this,a=t.rightShoulder.x*s+e,r=t.rightShoulder.y*s+i,o=t.leftShoulder.x*s+e,n=t.leftShoulder.y*s+i,p=t.leftHip.x*s+e,l=t.leftHip.y*s+i,_=t.rightHip.x*s+e,c=t.rightHip.y*s+i,d=_+(p-_)/6,u=r+2*(c-r)/3,g=p-(p-_)/6,f=n+2*(l-n)/3;quad(a,r,o,n,g,f,d,u),quad(d,u,g,f,p,l,_,c),this.draw_limb(t.rightElbow,t.rightWrist,a,r,h),this.draw_limb(t.leftElbow,t.leftWrist,o,n,h);let m=h/2,y=m;this.hflip||(m=-m),this.draw_limb(t.rightKnee,t.rightAnkle,_-m,c-y,h),this.draw_limb(t.leftKnee,t.leftAnkle,p+m,l-y,h)}draw_limb(t,e,i,s,h){let{px0:a,py0:r,r1:o}=this,n=t.x*o+a,p=t.y*o+r,l=h/2;s+=l;let _=l,c=atan2(s-p,i-n),d=i+_*cos(c-HALF_PI),u=s+_*sin(c-HALF_PI),g=i+_*cos(c+HALF_PI),f=s+_*sin(c+HALF_PI);_=l/2;let m=n+_*cos(c-HALF_PI),y=p+_*sin(c-HALF_PI),v=n+_*cos(c+HALF_PI),j=p+_*sin(c+HALF_PI);quad(d,u,g,f,v,j,m,y),this.draw_fore_limb(e,n,p,_),circle(i,s,h)}draw_fore_limb(t,e,i,s){let{px0:h,py0:a,r1:r}=this,o=t.x*r+h,n=t.y*r+a,p=atan2(i-n,e-o),l=e+s*cos(p-HALF_PI),_=i+s*sin(p-HALF_PI),c=e+s*cos(p+HALF_PI),d=i+s*sin(p+HALF_PI),u=o+s*cos(p-HALF_PI),g=n+s*sin(p-HALF_PI),f=o+s*cos(p+HALF_PI),m=n+s*sin(p+HALF_PI);quad(l,_,c,d,f,m,u,g),this.draw_hand_foot(o,n,s,p),circle(o,n,2*s),circle(e,i,2*s)}draw_hand_foot(t,e,i,s){let h=t-1*i*cos(s),a=e-1*i*sin(s),r=t-3*i*cos(s),o=e-3*i*sin(s),n=.75*i,p=h+n*cos(s-HALF_PI),l=a+n*sin(s-HALF_PI),_=h+n*cos(s+HALF_PI),c=a+n*sin(s+HALF_PI),d=1.5*i,u=r+d*cos(s-HALF_PI),g=o+d*sin(s-HALF_PI),f=r+d*cos(s+HALF_PI),m=o+d*sin(s+HALF_PI);quad(p,l,_,c,f,m,u,g)}drawKeypoints(t){noStroke();let e=this.eff_spec.urect,i=e.height,s=e.x0,h=e.y0,a=i/this.input.height,r=this.points_size;for(let e=0;e<t.length;e++){let i=e+this.points_color_offset,o=k[i%k.length];o[3]=this.alpha,fill(o);let n=t[e].pose;for(let t=0;t<n.keypoints.length;t++){let e=n.keypoints[t];if(e.score>.2){let{x:t,y:i}=e.position;t=t*a+s,i=i*a+h,ellipse(t,i,r,r)}}}}drawSkeleton(t){strokeWeight(this.skel_weight);let e=this.eff_spec.urect,i=e.height,s=e.x0,h=e.y0,a=i/this.input.height;for(let e=0;e<t.length;e++){let i=e+this.skel_color_offset,r=k[i%k.length];r[3]=this.alpha,stroke(r);let o=t[e].skeleton;for(let t=0;t<o.length;t++){let e=o[t],i=e[0].position,r=e[1].position,n=i.x,p=i.y,l=r.x,_=r.y;n=n*a+s,p=p*a+h,l=l*a+s,_=_*a+h,line(n,p,l,_)}}}}let k=[[255,255,0,255],[255,0,0,255],[0,255,0,255]];class I{static meta_props={record_fps:[4,6,12,24,30,60],record_duration:[5,10,20,30,60],record_start:{button:(t,e)=>{t.record_start(e)}},record_stop:{button:(t,e)=>{t.record_stop(e)}},record_save_name:{text_input:"record_log"},record_show:[0,1]};constructor(t){Object.assign(this,t),this.init()}init(){this.record_init()}prepareOutput(){if(this.eff_spec.ihide)this.output=this.input;else if(this.input){let t=this.input.get(),e=this.eff_spec,s={fliph:e.ifliph,flipv:e.iflipv};i(t,this.eff_spec.urect,s)}if(this.recording){let t=(Date.now()-this.start_time)/100;t=Math.trunc(t)/10,t!=this.lapseSec&&(this.lapseSec=t)}this.end_time<Date.now()&&(this.end_time=Number.MAX_SAFE_INTEGER,this.record_stop())}record_start(){ui_log("record_start"),this.recorder.start(),this.recording=1,this.start_time=Date.now(),this.end_time=Date.now()+1e3*this.record_duration,this.lapseSec=-1}record_stop(){ui_log("record_stop recording",this.recording),this.recording&&(ui_log("record_stop recorder.stop"),this.recorder.stop()),this.recording=0}record_init(){this.chunks=[],this.recording=0,this.end_time=Number.MAX_SAFE_INTEGER;let t=document.querySelector("canvas").captureStream(this.record_fps);this.recorder=new MediaRecorder(t),this.recorder.ondataavailable=t=>{t.data.size&&this.chunks.push(t.data)},this.recorder.onstop=t=>{this.exportVideo()}}exportVideo(){let t=new Blob(this.chunks,{type:"video/webm"});if(this.record_show){let e=document.createElement("video");e.setAttribute("id",Date.now()),e.controls=!0,document.body.appendChild(e),e.src=window.URL.createObjectURL(t)}let e=URL.createObjectURL(t),i=document.createElement("a");document.body.appendChild(i),i.style="display: none",i.href=e,i.download=this.record_save_name+".webm",i.click(),window.URL.revokeObjectURL(e),i.remove()}}class z{static meta_props={speed:[150,1,2,5,10,20,100],alpha:[255,230,180,100,10],phase_max:[200,50,100,200],edgeX:[0,1],edgeY:[0,1]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.update_phase(),this.sketchy_draw()}sketchy_draw(){e({to:this.a_image,from:this.input});let t=this.output.width;for(t=this.speed?Math.floor(t*(this.speed/100)):100;!this.filled&&t-- >0;)for(let t of this.objs)this.draw_obj(t)}update_phase(){this.phase_down--,this.phase_down<0&&(this.phase_down=this.phase_max,this.phase=1)}init_phase(){this.phase_down=this.phase_max,this.phase=0}completed_phase(){return this.phase}init(){let t=this.input.width,e=this.input.height;this.init_phase(),this.output=createGraphics(t,e),this.output.noStroke(),this.a_image||(this.a_image=createImage(t,e)),this.a_alpha=100,this.d_scale=1,this.objs=this.init_objs();for(let t of this.objs)this.initpos_obj(t)}init_objs(){return[{step:.01,pct:0,gray:0,x:0,y:50,d:100,d_range:[2,4],color_step:1},{step:.01,pct:0,gray:255,x:0,y:50,d:10,d_range:[5,10],color_step:-1}]}draw_obj(t){let e=this.output,i=this.a_image.get(t.x,t.y);i[3]=this.a_alpha;let s=t.d*this.d_scale;e.fill(i),e.circle(t.x-s/2,t.y,s),this.step_obj(t)}step_obj(t){t.pct<1?(t.x=t.startX+(t.stopX-t.startX)*t.pct,t.y=t.startY+(t.stopY-t.startY)*t.pct,t.pct+=t.step):this.nextpos_obj(t)}nextpos_obj(t){t.startX=t.stopX,t.startY=t.stopY,t.pct=0,this.init_stop(t,this.output)}initpos_obj(t){let e=this.output;this.d_scale=e.width/640,t.edgeX=this.edgeX,t.edgeY=this.edgeY,t.step=1/e.width*7,t.pct=0,this.init_stop(t,e),t.startX=round(random(t.w_range[0],t.w_range[1])),t.startY=round(random(t.h_range[0],t.h_range[1])),t.edgeX?t.startX=0:t.edgeY&&(t.startY=0)}init_stop(t){let e=this.output;t.d=random(t.d_range);let i=2*t.d;t.w_range=[-i,e.width+i],t.h_range=[-i,e.height+i],t.stopX=round(random(t.w_range[0],t.w_range[1])),t.stopY=round(random(t.h_range[0],t.h_range[1])),t.edgeX?(t.stopX=2&t.edgeX?0:t.w_range[1],t.edgeX^=2):t.edgeY&&(t.stopY=2&t.edgeY?0:t.h_range[1],t.edgeY^=2)}}class M{static meta_props={ncell:[512,1024,2028],step:[16,1,2,4,.2],start:[225,45,90,135,180,225,270,315],end:[360,90,135,180,270,315],delta:[5,1,2,4,6,8,16,32,64],r_mult:[4,16],dir_up:[0,1]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){strokeWeight(this.scan.xstep/2),e({to:this.image,from:this.input}),this.dir_up?this.draw_scan_up():this.draw_scan_down()}init(){this.angle=this.start,this.from_degrees=TWO_PI/360;let t=this.input.width,e=this.input.height;this.r=max(t,e)*this.r_mult,this.in_width=t,this.in_height=e,this.output=createGraphics(t,e),this.init_image(),this.init_scan(),this.init_src(),this.dir_up&&(this.scan.y=this.scan.yend-this.scan.ystep,this.src.y=this.src.yend-this.src.ystep)}draw_scan_up(){for(this.scan.x=this.scan.xstart,this.src.x=this.src.xstart;this.scan.x<this.scan.xend;){let t=this.scan.x+this.step,e=this.scan.y+this.step,i=this.image.get(this.src.x,this.src.y),s=this.angle*this.from_degrees,h=this.r*cos(s),a=this.r*sin(s);this.output.stroke(i),this.output.line(t,e,t+h,e+a),this.scan.x+=this.scan.xstep,this.src.x+=this.src.xstep}this.scan.y-=this.scan.ystep,this.src.y-=this.src.ystep,this.scan.y<this.scan.ystart&&(this.scan.y=this.scan.yend-this.scan.ystep,this.src.y=this.src.yend-this.src.ystep,this.angle+=this.delta,(this.angle>this.end||this.angle<this.start)&&(this.angle=this.start))}draw_scan_down(){for(this.scan.x=this.scan.xstart,this.src.x=this.src.xstart;this.scan.x<this.scan.xend;){let t=this.scan.x+this.step,e=this.scan.y+this.step,i=this.image.get(this.src.x,this.src.y),s=this.angle*this.from_degrees,h=this.r*cos(s),a=this.r*sin(s);this.output.stroke(i),this.output.line(t,e,t+h,e+a),this.scan.x+=this.scan.xstep,this.src.x+=this.src.xstep}this.scan.y+=this.scan.ystep,this.src.y+=this.src.ystep,this.scan.y>=this.scan.yend&&(this.scan.y=this.scan.ystart,this.src.y=this.src.ystart,this.angle+=this.delta,(this.angle>this.end||this.angle<this.start)&&(this.angle=this.start))}init_image(){let t=this.ncell,e=int(this.ncell*(this.in_height/this.in_width));this.image=createImage(t,e)}init_src(){this.src={},this.src.xstart=0,this.src.xend=this.image.width,this.src.xdim=this.src.xend-this.src.xstart,this.src.ystart=0,this.src.yend=this.image.height,this.src.ydim=this.src.yend-this.src.ystart,this.src.xstep=1,this.src.ystep=1,this.src.x=this.src.xstart,this.src.y=this.src.ystart}init_scan(){this.scan={},this.scan.xstep=this.in_width/this.ncell,this.scan.ystep=this.in_height/this.ncell,this.scan.xdim=this.in_width,this.scan.xstart=0,this.scan.xend=this.scan.xstart+this.scan.xdim,this.scan.ydim=this.in_height,this.scan.ystart=0,this.scan.yend=this.scan.ystart+this.scan.ydim,this.scan.x=this.scan.xstart,this.scan.y=this.scan.ystart}}class O{static meta_props={xdir:[1,0],step:[1,1,2,4,6,8,16,.2],auto_flip:[0,1],speed:[0,1,2,5,10,20,100],flip:{button:(t,e)=>{t.flip_action(e)}}};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.draw_slit()}init(){this.iimage=0,this.x=0,this.y=0,this.output=createImage(this.input.width,this.input.height)}flip_action(){this.xdir^=1}draw_slit(){this.filled=0;let t=this.xdir?this.output.width:this.output.height;for(t=this.speed?Math.floor(t*(this.speed/100)):1;!this.filled&&t-- >0;)this.draw_slit1()}draw_slit1(){let t=this.output.width,e=this.output.height,i=this.x,s=this.y,h=this.step;this.xdir?(this.input.loadPixels(),this.output.copy(this.input,t/2,0,h,e,i,0,h,e),this.x=this.x+this.step,this.x>t&&(this.filled=1,this.x=0,this.check_flip())):(this.input.loadPixels(),this.output.copy(this.input,0,e/2,t,h,0,s,t,h),this.y=this.y+this.step,this.y>e&&(this.filled=1,this.y=0,this.check_flip()))}check_flip(){this.auto_flip&&this.flip_action()}}class D{static meta_props={dcell:[5,10,20,30],rate:["frame","line","ncell"]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){for(e({to:this.img,from:this.input});!this.scan_draw_step(););}init(){this.iimage=0;let t=this.input.width,e=this.input.height;this.img=createImage(t,e),this.output=createGraphics(t,e),this.output.noStroke(),this.x=0,this.y=0,this.nstep=200,this.flag=1}scan_draw_step(){let t=this.output,e=this.img,i=this.dcell,s=e.get(this.x,this.y);t.fill(s);let h=this.x,a=this.y,r=h+i,o=a+i,n=h-i,p=a+i;this.flag&&(h=this.x-i,r=this.x+i,o=a,n=this.x),this.flag=!this.flag,t.triangle(h,a,r,o,n,p),this.x+=i;let l=e.width;return this.x>=l?(this.x=0,this.y+=i,this.flag=!this.flag,this.y>=e.height?(this.y=0,this.iimage++,"frame"===this.rate):"line"===this.rate):"ncell"===this.rate}}class S{static meta_props={factor:[10,1,5,10,20,40,50,100,200,500,1e3,2e3,3e3,5e3,1e4],mirror:[0,1],report:[0,1],frameCountMod:[20,1],activitySumLevel:[1,2,3,4]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.mirror?this.bestill_render_mirror():this.bestill_prepareOutput()}init(){this.stillf=[this.factor,this.factor,this.factor];let t=this.input;this.output=createImage(t.width,t.height),this.srcimage=createImage(this.output.width,this.output.height),this.srcimage2=createImage(this.output.width,this.output.height),this.buf=[],this.msum=1/(this.srcimage.width*this.srcimage.height)}bestill_prepareOutput(){if(!this.inited)return void this.buf_init();let{output:t,srcimage:i,buf:s,srcimage2:h}=this;e({to:i,from:this.input}),i.loadPixels(),t.loadPixels(),h.loadPixels();let a=0,r=this.factor,o=r-1,n=i.width,p=i.height;for(let e=0;e<p;e+=1)for(let p=0;p<n;p+=1){let l=4*(n*e+p);s[l]=(s[l]*o+i.pixels[l])/r,s[l+1]=(s[l+1]*o+i.pixels[l+1])/r,s[l+2]=(s[l+2]*o+i.pixels[l+2])/r,t.pixels[l]=s[l],t.pixels[l+1]=s[l+1],t.pixels[l+2]=s[l+2],a+=h.pixels[l]-i.pixels[l]+(h.pixels[l+1]-i.pixels[l+1])+(h.pixels[l+2]-i.pixels[l+2])}t.updatePixels(),frameCount%20==0&&e({to:h,from:i}),a*=this.msum,abs(a)>this.activitySumLevel?(globalThis.eff_bestill_mo_activitySum=a,this.report&&ui_log("eff_bestill_mo sum",a,"frameCount",frameCount)):globalThis.eff_bestill_mo_activitySum=0}bestill_render_mirror(){if(!this.inited)return void this.buf_init();let{output:t,srcimage:i,buf:s}=this;e({to:i,from:this.input}),i.loadPixels(),t.loadPixels(),srcimage2.loadPixels();let h=0,a=this.factor,r=a-1,o=i.width,n=i.height;for(let e=0;e<n;e+=1)for(let n=0;n<o;n+=1){let p=4*(o*e+n),l=4*(o*e+(o-1-n));s[p]=(s[p]*r+i.pixels[p])/a,s[p+1]=(s[p+1]*r+i.pixels[p+1])/a,s[p+2]=(s[p+2]*r+i.pixels[p+2])/a,t.pixels[l+0]=s[p+0],t.pixels[l+1]=s[p+1],t.pixels[l+2]=s[p+2],h+=srcimage2.pixels[p]-i.pixels[p]+(srcimage2.pixels[p+1]-i.pixels[p+1])+(srcimage2.pixels[p+2]-i.pixels[p+2])}t.updatePixels(),frameCount%this.frameCountMod==0&&image_copy_to(srcimage2,i),h*=this.msum,abs(h)>this.activitySumLevel?(globalThis.eff_bestill_mo_activitySum=h,this.report&&ui_log("eff_bestill_mo sum",h,"frameCount",frameCount)):globalThis.eff_bestill_mo_activitySum=0}buf_init(){this.inited=1;let{buf:t,output:i}=this,s=i.width,h=i.height;e({to:i,from:this.input}),i.loadPixels();for(let e=0;e<h;e+=1)for(let h=0;h<s;h+=1){let a=4*(s*e+h);t[a+0]=i.pixels[a+0],t[a+1]=i.pixels[a+1],t[a+2]=i.pixels[a+2]}}}class P{static meta_props={alpha:[255,230,180,100,10]};constructor(t){Object.assign(this,t),this.init(this)}prepareOutput(){this.eff_spec.ihide||(this.bodypix.segment(this.video,((t,e)=>{this.gotResults(t,e)})),this.segmentation&&image(this.segmentation.backgroundMask,0,0,width,height))}init(){this.videoKit.ui_message("loading model..."),this.video=this.input.elt;this.bodypix=ml5.bodyPix({outputStride:8,segmentationThreshold:.3})}gotResults(t,e){this.videoKit.ui_message(""),this.eff_spec.ihide||(t?ui_log("eff_body_pix",t):(this.segmentation=e,this.bodypix.segment(this.video,((t,e)=>{this.gotResults(t,e)}))))}}class E{static meta_props={center_draw:["pixd","mesh","dots","rects","tris","crop","cycle"],period:[1,-1,0,.5,1,2,3,4,5,6,10,20,30,60],next:{button:(t,e)=>{t.next_action(e)}},prev:{button:(t,e)=>{t.previous_action(e)}},pixd_n:[16,8,16,32,64,128],gray_back:[0,1,0],_freeze_patch:[0,1],center_only:[0,1],freeze_damp:[1,0,.5,1,2,3,4,5,6,10,20,30,60]};static clock_wise_pos=[[1,0],[2,0],[2,1],[2,2],[1,2],[0,2],[0,1],[0,0]];static center_pos=[1,1];constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.check_patches(),this.advancePending&&(this.draw_step(1),this.center_only&&this.draw_live(),this.advancePending=0),this.center_only||(this.freeze_patch&&this.wasFrozen?this.draw_live():this.draw_stamp()),this.draw_center(),this.period_timer.check((()=>{this.iperiod++,this.freeze_patch?this.wasFrozen||this.capture_live():this.advancePending=1}))}next_action(t){this.draw_step(1)}previous_action(t){this.draw_step(-1)}init(){this.ncell=3,this.wasFrozen=0,this.iperiod=0,this.period_timer=new h(this.period),this.twidth=width,this.theight=height,this.output=createGraphics(this.twidth,this.theight),this.xstep=Math.floor(this.twidth/this.ncell),this.ystep=Math.floor(this.theight/this.ncell),this.img_live=createImage(this.xstep,this.ystep),this.index=0,this.draw_step(0),this.center_layer=createGraphics(this.xstep,this.ystep),this.pixd_img=createImage(this.pixd_n,this.pixd_n),this.face_mesh_center={align:"center",alpha:255,mar_h:5,draw:this.center_draw,ddraw:this.center_draw,slen:5,output:this.center_layer,from:0,to:1,avg_color:[255,255,255,255],pixd_img:this.pixd_img},this.advancePendingTime=0}deinit(){this.output.remove(),this.center_layer.remove()}draw_center(){let t=this.center_layer,e=t.width,i=t.height,{xstep:s,ystep:h}=this,a=s,r=h;this.output.copy(t,0,0,e,i,a,r,s,h)}patch_stepper(){this.advancePending=1}draw_step(t){let[e,i]=this.constructor.clock_wise_pos[this.index],s=this.constructor.clock_wise_pos.length;this.index=(this.index+t+s)%s,this.x=this.xstep*e,this.y=this.ystep*i}check_patches(){if(this.freeze_patch){let t=this.videoKit.patch_index1(this.freeze_patch);if(t){if(this.advancePendingTime){((new Date).getTime()-this.advancePendingTime)/1e3>this.freeze_damp&&t.frozen&&(this.advancePending=1,this.advancePendingTime=0)}else!this.wasFrozen&&t.frozen&&(this.advancePendingTime=(new Date).getTime());this.wasFrozen=t.frozen,this.draw_to_center_layer(t)}}}draw_to_center_layer(t){let e=this.center_layer;e.clear(),this.gray_back?e.background(this.face_mesh_center.avg_color):t.avg_color&&e.background(t.avg_color),e.noStroke(),g(this.face_mesh_center,t.img,t.predictions)}draw_stamp(){let t=this.input;if(this.advancePending)return;let e=t.width,i=t.height,{x:s,y:h,xstep:a,ystep:r}=this;this.output.copy(t,0,0,e,i,s,h,a,r),this.last_x=s,this.last_y=h}draw_live(){let t=this.img_live,e=t.width,i=t.height,{xstep:s,ystep:h}=this,a=this.last_x,r=this.last_y;this.center_only&&(a=this.x,r=this.y),this.output.copy(t,0,0,e,i,a,r,s,h)}capture_live(){let t=this.img_live,{xstep:e,ystep:i}=this,s=this.last_x,h=this.last_y;this.center_only&&(s=e,h=i),t.copy(this.output,s,h,e,i,0,0,t.width,t.height)}}class C{static meta_props={ncell:[2,3,4],icell:0,ncell_max:4,period:[5,-1,0,.5,1,2,3,4,5,6,10,20,30,60],next:{button:(t,e)=>{t.next_action(e)}},prev:{button:(t,e)=>{t.previous_action(e)}},ifirst:[1,2],_freeze_patch:[0,1],livem_cycle:[0,1],show_all:[1,0]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.check_patches(),this.freeze_patch&&this.wasFrozen?this.draw_freeze():this.draw_frame(),this.advancePending&&(this.livem_cycle?this.livem_step():this.draw_step(),this.advancePending=0),this.period_timer.check((()=>{this.iperiod++,this.freeze_patch?this.wasFrozen||this.capture_freeze():this.advancePending=1}))}livem_step(){if(!this.livem_cycle)return;let t=this.eff_spec.ipatch,e=this.videoKit.a_.ui.patches[t],i=e.eff_spec.imedia;i>=this.videoKit.a_.mediaDivs.length&&(i=this.ifirst),i=(i+1)%this.videoKit.a_.mediaDivs.length,i<this.ifirst&&(i=this.ifirst),i>=this.videoKit.a_.mediaDivs.length&&(i=e.eff_spec.imedia),e.eff_spec.imedia!==i&&(e.eff_spec.imedia=i,this.draw_step())}check_mediaDivs(){this.old_mediaDivs_length!=this.videoKit.a_.mediaDivs.length&&(this.old_mediaDivs_length=this.videoKit.a_.mediaDivs.length,this.videoKit.a_.mediaDivs.length,this.ifirst)}init(){this.wasFrozen=0,this.iperiod=0,this.period_timer=new h(this.period);let{width:t,height:e}=this.eff_spec.urect;this.twidth=t,this.theight=e,this.output=createGraphics(this.twidth,this.theight),this.x=0,this.y=0,this.init_step()}init_step(){let t=this.ncell,e=this.ncell;this.xstep=Math.floor(this.twidth/t),this.ystep=Math.floor(this.theight/e),this.img_freeze=createImage(this.xstep,this.ystep)}draw_frame(){this.show_all?this.draw_all():this.draw_single(this.input)}draw_all(){this.check_mediaDivs();let t=this.eff_spec.ipatch,e=this.videoKit.a_.ui.patches[t],i=e.eff_spec.imedia%this.videoKit.a_.mediaDivs.length;if(i!=e.eff_spec.imedia)return;let s=this.videoKit.a_.mediaDivs.length-this.ifirst,h=this.input,a=this.x,r=this.y,o=i;for(;s>0;){this.draw_single(h),o=(o+1)%this.videoKit.a_.mediaDivs.length,o<this.ifirst&&(o=this.ifirst),h=this.videoKit.a_.mediaDivs[o].capture,s--,this.draw_step()}this.x=a,this.y=r}draw_single(t){if(this.advancePending)return;if(!this.media.ready())return void ui_log("draw_single NOT Ready imedia",this.eff_spec.imedia);let e=t.width,i=t.height,{x:s,y:h,xstep:a,ystep:r}=this;this.output.copy(t,0,0,1,1,s,h,a,r);let o=r*(e/i),n=Math.floor(s+(a-o)/2);this.output.copy(t,0,0,e,i,n,h,o,r),this.last_x=s,this.last_y=h}patch_stepper(){this.advancePending=1}draw_step(t){t||(t=1);let e=this.ncell,i=this.ncell;this.x+=this.xstep*t,(this.x+this.xstep/2>=this.output.width||this.x<0)&&(this.x<0?this.x=this.xstep*(e-1):this.x=0,this.y+=this.ystep*t,this.y<0&&(this.y=this.ystep*(i-1)),this.y>=this.output.height&&(this.y=0))}src_image(){return this.input}next_action(t){this.draw_step()}previous_action(t){this.draw_step(-1)}check_patches(){if(this.freeze_patch){let t=this.videoKit.patch_index1(this.freeze_patch);t&&(!this.wasFrozen&&t.frozen&&(this.advancePending=1),this.wasFrozen=t.frozen)}}draw_freeze(){let t=this.img_freeze,e=t.width,i=t.height,{xstep:s,ystep:h}=this,a=this.last_x,r=this.last_y;this.output.copy(t,0,0,e,i,a,r,s,h)}capture_freeze(){let t=this.img_freeze,{xstep:e,ystep:i}=this,s=this.last_x,h=this.last_y;t.copy(this.output,s,h,e,i,0,0,t.width,t.height)}}let A={"370-img":["IMG_1288.JPG","IMG_1289.JPG","IMG_1290.JPG","IMG_1292.JPG","IMG_1293.JPG","IMG_1295.JPG","IMG_E1288.JPG","IMG_E1289.JPG","IMG_E1290.JPG","IMG_E1292.JPG","IMG_E1293.JPG","IMG_E1295.JPG"],"370-mov":["IMG_1294.MOV","IMG_1296.MOV","IMG_1297.MOV"],covid19m:["Update 10_19_ The COVID - 19 MEMORIAL TICKER (00).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (01).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (02).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (03).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (04).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (05).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (06).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (07).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (08).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (09).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (10).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (11).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (12).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (13).png","Update 10_19_ The COVID - 19 MEMORIAL TICKER (14).png"],covid19mov:["Document_Ticker-short-h.mov","MadibaViolaCello-h.mov"],fema:["212.jpg","216.jpg","217.jpg","218.jpg","225.jpg","227.jpg","231.jpg","237.jpg","238.jpg","239.jpg","240.jpg","241.jpg","245.jpg","249.jpg","251.jpg","252.jpg","255.jpg","261.jpg","263.jpg","264.jpg","267.jpg","278.jpg","283.jpg","286.jpg","287.jpg","288.jpg","291.jpg","295.jpg","297.jpg","298.jpg","299.jpg","300.jpg","301.jpg","308.jpg","309.jpg","310.jpg","311.jpg","316.jpg","320.jpg","321.jpg","322.jpg","325.jpg","327.jpg","330.jpg","341.jpg","342.jpg","343.jpg","346.jpg","350.jpg","355.jpg","359.jpg","360.jpg","362.jpg","367.jpg","373.jpg","375.jpg","398.jpg","400.jpg","403.jpg","407.jpg","410.jpg","420.jpg","423.jpg","425.jpg","462.jpg","465.jpg"],"fema-bb":["212.jpg","216.jpg","217.jpg","218.jpg","225.jpg","227.jpg","231.jpg","237.jpg","238.jpg","239.jpg","240.jpg","241.jpg","245.jpg","249.jpg","251.jpg","252.jpg","255.jpg","261.jpg","263.jpg","264.jpg","267.jpg","278.jpg","283.jpg","286.jpg","287.jpg","288.jpg","291.jpg","295.jpg","297.jpg","298.jpg","299.jpg","300.jpg","301.jpg","308.jpg","309.jpg","310.jpg","311.jpg","316.jpg","320.jpg","321.jpg","322.jpg","325.jpg","327.jpg","330.jpg","341.jpg","342.jpg","343.jpg","346.jpg","350.jpg","355.jpg","359.jpg","360.jpg","362.jpg","367.jpg","373.jpg","375.jpg","398.jpg","400.jpg","403.jpg","407.jpg","410.jpg","420.jpg","423.jpg","425.jpg","462.jpg","465.jpg"],fema_new:["421.jpg"],graph:["073.jpg","074.jpg","076.jpg","077.jpg","082.jpg","083.jpg","084.jpg","085.jpg","086.jpg","087.jpg","088.jpg","089.jpg","090.jpg","091.jpg","092.jpg","093.jpg","094.jpg","095.jpg","096.jpg","097.jpg","098.jpg","099.jpg","100.jpg","101.jpg","102.jpg","103.jpg","104.jpg","105.jpg","106.jpg","107.jpg","108.jpg","109.jpg","110.jpg","111.jpg","112.jpg","113.jpg","114.jpg","115.jpg","116.jpg","119.jpg","120.jpg","121.jpg","122.jpg","123.jpg","124.jpg","125.jpg","126.jpg","127.jpg","128.jpg","129.jpg","130.jpg","131.jpg","132.jpg","133.jpg","134.jpg","135.jpg"],group:["001.jpg","002.jpg","004.jpg","005.jpg","006.jpg","007.jpg","008.jpg","009.jpg","010.jpg","019.jpg","028.jpg","030.jpg","040.jpg","153.jpg","154.jpg","155.jpg","160.jpg","166.jpg","169.jpg","171.jpg","173.jpg","174.jpg","176.jpg","177.jpg","181.jpg","182.jpg","185.jpg","186.jpg","207.jpg","208.jpg","210.jpg","258.jpg","442.jpg","471.jpg","539.jpg","541.jpg","542.jpg","544.jpg","547.jpg"],jht:["IMG_4491.JPEG","IMG_5398.JPEG","IMG_6338.JPEG","IMG_6410.JPEG","IMG_6498.JPG","IMG_6885.JPEG","IMG_6946.JPEG","IMG_7146.JPEG","IMG_7436.JPEG","IMG_7555.JPEG","skin-tone-guest-v3.png"],male:["068.jpg","187.jpg","189.jpg","191.jpg","193.jpg","194.jpg","196.jpg","197.jpg","198.jpg","200.jpg","201.jpg","203.jpg","213.jpg","222.jpg","229.jpg","262.jpg","266.jpg","269.jpg","270.jpg","271.jpg","274.jpg","277.jpg","281.jpg","285.jpg","304.jpg","351.jpg","352.jpg","353.jpg","354.jpg","372.jpg","382.jpg","384.jpg","390.jpg","393.jpg","395.jpg","399.jpg","412.jpg","416.jpg","418.jpg","478.jpg"],"male-bb":["068.jpg","187.jpg","189.jpg","191.jpg","193.jpg","194.jpg","196.jpg","197.jpg","198.jpg","200.jpg","201.jpg","203.jpg","213.jpg","222.jpg","229.jpg","262.jpg","266.jpg","269.jpg","270.jpg","271.jpg","274.jpg","277.jpg","281.jpg","285.jpg","304.jpg","351.jpg","352.jpg","353.jpg","354.jpg","372.jpg","382.jpg","384.jpg","390.jpg","393.jpg","395.jpg","399.jpg","412.jpg","416.jpg","418.jpg","478.jpg"],male_new:["305.jpg"],other:["211.jpg","219.jpg","233.jpg","234.jpg","235.jpg","236.jpg","260.jpg","265.jpg","275.jpg","289.jpg","290.jpg","302.jpg","348.jpg","376.jpg","379.jpg","385.jpg","387.jpg","388.jpg","391.jpg","394.jpg","396.jpg","406.jpg","430.jpg","431.jpg","432.jpg","433.jpg","448.jpg","463.jpg","464.jpg","488.jpg","551.jpg","553.jpg"],screens:["IM-Screens-Flyer-2.jpg","Screens-Club.png","yoga-thursday-IMG_3323.jpeg","yoga-thursday-IMG_3355.jpeg","yoga-thursday-IMG_3355a.jpeg"],test:["fac.png"],"z-fema":["214.jpg","215.jpg","220.jpg","221.jpg","223.jpg","224.jpg","226.jpg","228.jpg","232.jpg","242.jpg","243.jpg","244.jpg","246.jpg","250.jpg","253.jpg","254.jpg","256.jpg","257.jpg","279.jpg","282.jpg","292.jpg","293.jpg","294.jpg","296.jpg","303.jpg","306.jpg","312.jpg","313.jpg","315.jpg","318.jpg","319.jpg","323.jpg","324.jpg","326.jpg","328.jpg","331.jpg","333.jpg","334.jpg","335.jpg","336.jpg","337.jpg","338.jpg","339.jpg","340.jpg","344.jpg","345.jpg","347.jpg","349.jpg","358.jpg","363.jpg","370.jpg","374.jpg","377.jpg","378.jpg","380.jpg","381.jpg","383.jpg","389.jpg","392.jpg","397.jpg","401.jpg","402.jpg","404.jpg","405.jpg","408.jpg","409.jpg","413.jpg","414.jpg","419.jpg","421.jpg","422.jpg","424.jpg","426.jpg","468.jpg"],"z-graph":["069.jpg","078.jpg","079.jpg","080.jpg","081.jpg","117.jpg","118.jpg","136.jpg","140.jpg"],"z-male":["188.jpg","190.jpg","192.jpg","195.jpg","199.jpg","202.jpg","230.jpg","247.jpg","248.jpg","272.jpg","273.jpg","276.jpg","280.jpg","284.jpg","305.jpg","307.jpg","314.jpg","317.jpg","329.jpg","332.jpg","356.jpg","357.jpg","361.jpg","364.jpg","365.jpg","366.jpg","369.jpg","371.jpg","386.jpg","411.jpg","415.jpg","417.jpg","460.jpg","470.jpg","472.jpg","473.jpg","479.jpg"],fmfm:["../fema/212.jpg","../male/068.jpg","../fema/216.jpg","../male/187.jpg","../fema/217.jpg","../male/189.jpg","../fema/218.jpg","../male/191.jpg","../fema/225.jpg","../male/193.jpg","../fema/227.jpg","../male/194.jpg","../fema/231.jpg","../male/196.jpg","../fema/237.jpg","../male/197.jpg","../fema/238.jpg","../male/198.jpg","../fema/239.jpg","../male/200.jpg","../fema/240.jpg","../male/201.jpg","../fema/241.jpg","../male/203.jpg","../fema/245.jpg","../male/213.jpg","../fema/249.jpg","../male/222.jpg","../fema/251.jpg","../male/229.jpg","../fema/252.jpg","../male/262.jpg","../fema/255.jpg","../male/266.jpg","../fema/261.jpg","../male/269.jpg","../fema/263.jpg","../male/270.jpg","../fema/264.jpg","../male/271.jpg","../fema/267.jpg","../male/274.jpg","../fema/278.jpg","../male/277.jpg","../fema/283.jpg","../male/281.jpg","../fema/286.jpg","../male/285.jpg","../fema/287.jpg","../male/304.jpg","../fema/288.jpg","../male/351.jpg","../fema/291.jpg","../male/352.jpg","../fema/295.jpg","../male/353.jpg","../fema/297.jpg","../male/354.jpg","../fema/298.jpg","../male/372.jpg","../fema/299.jpg","../male/382.jpg","../fema/300.jpg","../male/384.jpg","../fema/301.jpg","../male/390.jpg","../fema/308.jpg","../male/393.jpg","../fema/309.jpg","../male/395.jpg","../fema/310.jpg","../male/399.jpg","../fema/311.jpg","../male/412.jpg","../fema/316.jpg","../male/416.jpg","../fema/320.jpg","../male/418.jpg","../fema/321.jpg","../male/478.jpg","../fema/322.jpg","../male/068.jpg","../fema/325.jpg","../male/187.jpg","../fema/327.jpg","../male/189.jpg","../fema/330.jpg","../male/191.jpg","../fema/341.jpg","../male/193.jpg","../fema/342.jpg","../male/194.jpg","../fema/343.jpg","../male/196.jpg","../fema/346.jpg","../male/197.jpg","../fema/350.jpg","../male/198.jpg","../fema/355.jpg","../male/200.jpg","../fema/359.jpg","../male/201.jpg","../fema/360.jpg","../male/203.jpg","../fema/362.jpg","../male/213.jpg","../fema/367.jpg","../male/222.jpg","../fema/373.jpg","../male/229.jpg","../fema/375.jpg","../male/262.jpg","../fema/398.jpg","../male/266.jpg","../fema/400.jpg","../male/269.jpg","../fema/403.jpg","../male/270.jpg","../fema/407.jpg","../male/271.jpg","../fema/410.jpg","../male/274.jpg","../fema/420.jpg","../male/277.jpg","../fema/423.jpg","../male/281.jpg","../fema/425.jpg","../male/285.jpg","../fema/462.jpg","../male/304.jpg","../fema/465.jpg","../male/351.jpg"]},L=["group","fmfm","fema","male","group","graph","other","test","jht","covid19m","370-img","screens"];class G{static meta_props={group:L,next:{button:(t,e)=>{t.next_action(e)}},prev:{button:(t,e)=>{t.previous_action(e)}},reset:{button:(t,e)=>{t.reset_action(e)}},labeled:[0,1],label_align:["center","left","right"],image_align:["none","center"],flip_h:[0,1],_loop:[0,1],period:[5,10,20,30,60],shuffle:[0,1,0],_face:["none","mesh","points"],align:["center","none"],alpha:[255,230,180,100,10],color:["black","white","color"],ncell:[32,64,128,256,512,16],shape:["circle","rect"],_zoomed:[0,1],peg_width:[1,0],zoom_out:{button:(t,e)=>t.zoom_out_action(e)},pan:{button:(t,e)=>t.pan_action(e)},add:{button:(t,e)=>t.add_action(e)},pan_ease:[0,1],_export_on:[0,1],export_do:{button:(t,e)=>{t.export_action(e)}}};constructor(t){Object.assign(this,t),this.image_name="test/fac.png",this.load_msg=1,this.reveal=0,this.bbox=0,this.wt=0,this.col_black="black"===this.color,this.col_white="white"===this.color,this.shapef="rect"===this.shape?rect:ellipse,this.avg_color=[255,255,255,255],this.init(),this.zoom_init(),this.align_center="center"===this.image_align,this.videoKit.my_canvas.mousePressed((()=>{this.mousePressed()})),this.output=createGraphics(this.eff_spec.urect.width,this.eff_spec.urect.height)}prepareOutput(){this.img&&(this.loop&&this.period_timer.check((()=>{this.period_next()})),this.pan_check(),this.show_image(),this.face_prepareOutput())}init(){this.predictions=[],this.period_timer=new h(this.period),this.load_image()}show_image(){this.zoomed?this.show_zoomed(this.img,this.eff_spec.urect):s(this.output,this.img,this.eff_spec.urect,this.align_center,this.flip_h),this.draw_image_name()}draw_image_name(){if(!this.labeled)return;let t=this.output,e=this.image_name.lastIndexOf("/")+1,i=this.image_name.lastIndexOf("."),s=this.image_name.substr(e,i-e),h=t.textAscent(),a=t.textDescent(),r=t.textWidth(s);t.fill("black");let o=4+h+a,n=t.width,p=0;"center"==this.label_align?p+=n/4-(r+2)/2:"right"==this.label_align?p+=n-(r+2):p+=2;let l=t.height-o;t.rect(p,l,r+4,o),t.fill("white"),p+=2,l+=h+2,t.text(s,p,l)}show_zoomed(t,e){e||(e={width:width,height:height,x0:0,y0:0});let i=e.width,s=e.height,h=t.width,a=t.height,r=a/h;this.peg_width?s=i*r:i=s/r,h=i*this.zscale,a=s*this.zscale,image(t,e.x0,e.y0,i,s,this.zx0,this.zy0,h,a)}mouseDragged(){this.zx0=(this.mouseX-mouseX)*this.zscale,this.zy0=(this.mouseY-mouseY)*this.zscale}mousePressed(){ui_log("eff_image_show mousePressed"),keyIsPressed&&keyCode==SHIFT&&(this.zscale/=2),this.mouseX=this.zx0/this.zscale+mouseX,this.mouseY=this.zy0/this.zscale+mouseY}mouseReleased(){}zoom_init(){this.show=!this.zoomed,this.zx0=0,this.zy0=0,this.zscale=4,this.mouseX=0,this.mouseY=0,this.pan_index=0}pan_action(){ui_log("pan_action",this.image_name);let t=R[this.image_name];if(!t)return 1;let e=t[this.pan_index];this.pan_index=(this.pan_index+1)%t.length,this.pan_ease?this.pan_target=e:(this.zx0=e.x,this.zy0=e.y,this.zscale=e.s)}pan_check(){if(!this.pan_target)return;let t=.05,e=this.pan_target;this.zx0+=(e.x-this.zx0)*t,this.zy0+=(e.y-this.zy0)*t,this.zscale+=(e.s-this.zscale)*t}add_action(){let t={x:this.zx0,y:this.zy0,s:this.zscale},e=R[this.image_name];e||(e=[],R[this.image_name]=e),e.push(t);let i=JSON.stringify(R,null,2);ui_log(i)}zoom_out_action(){this.zscale,this.zoom_init(),this.zscale=this.zscale_org,ui_log("this.zscale",this.zscale)}face_prepareOutput(){noStroke(),"points"===this.face&&this.draw_face_points(this.predictions)}export_action(){let t=this.replace_ext(this.image_name,".json");saveJSON(this.predictions,t)}next_action(t){t.eff_props.iimage||(t.eff_props.iimage=0),t.eff_props.iimage=(t.eff_props.iimage+1)%this.images.length,this.videoKit.ui_patch_update(t)}previous_action(t){t.eff_props.iimage||(t.eff_props.iimage=0),t.eff_props.iimage--,this.videoKit.ui_patch_update(t)}reset_action(t){delete t.iimage,this.videoKit.ui_patch_update(t)}period_next(){this.iimage||(this.iimage=0),this.iimage=(this.iimage+1)%this.images.length,this.load_image()}load_image(){this.nnits=0,this.images=A[this.group],this.shuffle&&(this.images=shuffle(this.images));let t=this.image_name;void 0!==this.iimage&&(this.iimage>=this.images.length&&(this.iimage=this.images.length-1),t=this.group+"/"+this.images[this.iimage]),loadImage("./external/media/webdb/"+t,(e=>{ui_log("eff_image_show img.width",e.width,"height",e.height),ui_log("eff_image_show output width",this.output.width,"height",this.output.height),ui_log("eff_image_show pad width",this.eff_spec.urect.width,"height",this.eff_spec.urect.height),this.zoomed&&(this.zscale=e.width/this.eff_spec.urect.width,this.zscale_org=this.zscale,ui_log("eff_image_show this.zscale",this.zscale)),ui_log("ipatch",this.eff_spec.ipatch,"image_name",t),this.imageReady(e,t)}))}imageReady(t,e){if(this.img=t,this.image_name=e,"none"===this.face)return;let i="./external/media/webdb/"+this.replace_ext(this.image_name,".json");ui_log("eff_image_show jpath",i),this.export_on?this.load_model():loadJSON(i,(t=>{this.predictions=t}),(t=>{ui_log("loadJSON err",t),this.load_model()}))}replace_ext(t,e){let i=t.lastIndexOf(".");return this.image_name.substring(0,i)+e}load_model(){this.load_msg&&this.videoKit.ui_message("loading model..."),this.facemesh=ml5.facemesh((()=>{this.videoKit.ui_message(""),this.facemesh.predict(this.img)})),this.facemesh.on("predict",(t=>{this.predictions=t,this.export_on&&this.export_action()}))}draw_face_points(t){let e=this.img,i=(t,i)=>{let s=e.get(t,i);return s[3]=this.alpha,s};this.col_black?i=(t,e)=>[0,0,0,this.alpha]:this.col_white&&(i=(t,e)=>[255,255,255,this.alpha]);let s=this.eff_spec.urect,h=s.width,a=s.height,r=s.x0,o=s.y0,n=a/e.height,p=h/this.ncell,l="none"===this.align,_="center"===this.align,c="right"===this.align;noStroke();for(let e=0;e<t.length;e+=1){const s=t[e].scaledMesh;let[d,u]=s[10],[g,f]=s[152];d=s[234][0],g=s[454][0];let m=g-d,y=f-u;noFill(),rect(r+d*n,o+u*n,m*n,y*n);let v=a/y,j=0;c?j=h-m*v:_?j=(h-m*v)/2:l&&(v=n,d=0,u=0);for(let t=0;t<s.length;t+=1){let[e,h]=s[t],a=i(e,h);e=(e-d)*v+j,h=(h-u)*v,fill(a),this.shapef(r+e,o+h,p,p)}}}}let F,T,K,R={"group/002.jpg":[{x:252.8,y:475.2,s:.8},{x:1004,y:500,s:.8},{x:1684.8,y:509.6,s:.8},{x:2676,y:611.2,s:.8},{x:588,y:1156.8,s:.8},{x:1598.4,y:1111.2,s:.8},{x:2541.6,y:1196.8,s:.8},{x:0,y:0,s:3.2}],"group/001.jpg":[{x:394,y:740.8,s:.4},{x:828,y:726.8,s:.4},{x:1218.8,y:732.4,s:.4},{x:1814,y:664.4,s:.4},{x:2276,y:567.6,s:.4},{x:2846.8,y:649.2,s:.4},{x:3240,y:652.4,s:.4},{x:0,y:0,s:3.2}]};class N{static meta_props={image_patch:[0,1,2,3,4,5,6,7,8,9,10],align:["center","left","right","none"],alpha:[255,230,180,100,10],mar_h:[0,0,2,5,10],draw:["mesh","dots","rects","tris","crop"],slen:[5,1,2,3,4,5,10]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){let t=this.videoKit.patch_index1(this.image_patch);if(t&&t.predictions&&t.img){this.ddraw=this.draw;let e=this.output;e.clear(),e.noStroke(),g(this,t.img,t.predictions)}}init(){this.from=0,this.to=1,this.avg_color=[255,255,255,255],this.output=createGraphics(this.eff_spec.urect.width,this.eff_spec.urect.height)}}class J{constructor(t){Object.assign(this,t),this.init_analyser()}init_analyser(){let t=getAudioContext();if(t.resume(),!this.media.mediaDevice)return;let e=this.media.mediaDevice.stream;this.analyser=t.createAnalyser();try{t.createMediaStreamSource(e).connect(this.analyser)}catch(t){ui_log("createMediaStreamSource err",t)}this.spectrum_arr=new Uint8Array(this.analyser.frequencyBinCount)}spectrum(){return this.analyser?(this.analyser.getByteFrequencyData(this.spectrum_arr),this.spectrum_arr):[]}}class V{static meta_props={align:["center","left","right","none"],alpha:[255,230,180,100,10],size:[.2,.1,.2,.3,.4,.5,.6,.7,.8,.9,1],back_color:[0,1],fft:[1,0]};constructor(t){Object.assign(this,t),this.init(this)}prepareOutput(){this.output.clear(),this.output.noStroke(),this.facemesh&&(this.facemesh.video=this.video),this.drawKeypoints(this.predictions),this.back_color&&(fill(this.avg_color),rect(this.eff_spec.urect.x0,this.eff_spec.urect.y0,this.eff_spec.urect.width,this.eff_spec.urect.height)),i(this.output,this.eff_spec.urect)}init(){if(ui_log("eff_face_band init",this),this.fft_anal=new J({media:this.media}),this.video=this.input.elt,this.predictions=[],"undefined"==typeof ml5)return;this.videoKit.ui_message("loading model..."),this.facemesh=ml5.facemesh(this.video,(()=>{this.videoKit.ui_message("")})),this.facemesh.on("predict",(t=>{0!==t.length?(this.predictions=t,this.frozen=0):this.frozen=1}));let t=this.input.width,e=this.input.height;this.img=createImage(t,e),this.avg_color=[255,255,255,255],this.img=createImage(this.input.width,this.input.height),this.output=createGraphics(this.eff_spec.urect.width,this.eff_spec.urect.height)}drawKeypoints(t){let i=this.output,s=this.img;this.frozen||e({to:s,from:this.input});let h=this.eff_spec.urect,a=h.width,r=h.height,o=r/s.height,n="none"===this.align,p="center"===this.align,l="right"===this.align,_=1-this.size,c=[],d=[0,0,0],u=0;if(this.fft){let t=this.fft_anal.spectrum(),e=t.length-1,i=int(18),s=0;for(let i=e;i>=0;i--){if(t[i]>0){s=i;break}}let h=int((s+1)/36),a=0;for(let e=0;e<=i;e++){let i=0;for(let e=0;e<h;e++)i+=t[a],a++;i/=h;let s=map(i,0,255,1,0);c[e]=s,c[36-e]=s}}else for(let t=0;t<36;t++)c[t]=_;for(let e=0;e<t.length;e+=1){const h=t[e],_=h.scaledMesh;let[g,f]=_[10],[m,y]=_[152];g=_[234][0],m=_[454][0];let v=m-g,j=r/(y-f),x=0;l?x=a-v*j:p?x=(a-v*j)/2:n&&(j=o,g=0,f=0);let w=[...h.annotations.silhouette];i.strokeWeight(0);let b,[k,I]=_[1];k=(k-g)*j+x,I=(I-f)*j,w.push(w[0]);for(let t=0;t<36;t++){let[e,h]=w[t];b=s.get(e,h),b[3]=this.alpha,d[0]+=b[0],d[1]+=b[1],d[2]+=b[2],u++;let[a,r]=w[t+1];e=(e-g)*j+x,h=(h-f)*j;let o=k+(e-k)*c[t],n=I+(h-I)*c[t];a=(a-g)*j+x,r=(r-f)*j;let p=k+(a-k)*c[t],l=I+(r-I)*c[t];i.fill(b),i.quad(e,h,a,r,p,l,o,n)}u>0&&(this.avg_color[0]=int(d[0]/u),this.avg_color[1]=int(d[1]/u),this.avg_color[2]=int(d[2]/u))}}}class H{static meta_props={max:[5,6,7,2,4,8,9,10]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.output.clear(),this.draw_fft()}init(){let{width:t,height:e}=this.eff_spec.urect;this.output=createGraphics(t,e),this.output.noStroke(),this.alpha=20,this.alpha2=200,this.start=0,this.end=100*this.max,this.base=0,this.vols=[],this.fft_maxs=[],this.vol_len=Math.pow(t/960,.5),this.n_vol=int(this.output.width/this.vol_len),this.fft_anal=new J({media:this.media})}draw_fft(){let t=this.output,e=this.fft_anal.spectrum(),i=Math.round(e.length*this.start/1e3),s=Math.round(e.length*this.end/1e3),h=width/(s-i),a=0;for(let r=i;r<s;r++){let o=e[r];t.fill(o,0,0,this.alpha2);let n=map(r,i,s,0,width),p=map(o,this.base,255,0,height);t.rect(n,height-p,h,p),p>a&&(a=p)}this.fft_maxs.push(a),this.fft_maxs.length>this.n_vol&&this.fft_maxs.splice(0,1),this.draw_fft_max()}draw_fft_max(){let t=this.eff_spec.urect,{width:e,height:i}=t,s=this.output,h=e-this.fft_maxs.length*this.vol_len;h<0&&(h=0);let a=i,r=5*this.vol_len;for(let t of this.fft_maxs){let e=map(t,0,a,150,255);s.fill(e,e,0,this.alpha),s.rect(h,a-t,r,t),h+=this.vol_len}}}class U{static meta_props={max:[5,6,7,2,4,8,9,10],delta:[1,5,10,15],period:[30,5,10,20,30,60]};constructor(t){Object.assign(this,t),this.init()}prepareOutput(){this.period_timer.check((()=>{this.period_next()})),this.draw_fft(),i(this.output,this.eff_spec.urect)}init(){this.output=createGraphics(this.eff_spec.urect.width,this.eff_spec.urect.height);let t=this.output;t.noStroke(),this.alpha_line=10,this.alpha_hist=20,this.start=0,this.end=100*this.max,this.base=0,this.vols=[],this.fft_maxs=[],this.vol_len=1,this.n_vol=int(t.width/this.vol_len),this.th_offset=0,this.th_delta=TWO_PI/360*this.delta,this.x0=t.width/2,this.y0=t.height/2,this.fft_anal=new J({media:this.media}),this.period_timer=new h(this.period)}draw_fft(){let t=this.fft_anal.spectrum(),e=this.output,i=Math.round(t.length*this.start/1e3),s=Math.round(t.length*this.end/1e3),h=0;for(let e=s;e>i;e--){if(t[e]>0){h=e;break}}let a=this.x0,r=this.y0;for(let o=i;o<s;o++){let s=t[o],n=map(o,i,h,0,TWO_PI),p=map(s,this.base,255,0,1);p*=r,n+=this.th_offset;let l=p*cos(n),_=p*sin(n);e.stroke(s,0,0,this.alpha_line),e.line(a,r,a+l,r+_)}this.fft_maxs.push(0),this.fft_maxs.length>this.n_vol&&this.fft_maxs.splice(0,1),this.th_offset+=this.th_delta}draw_fft_max(){let t=this.output,e=t.width-this.fft_maxs.length*this.vol_len;e<0&&(e=0);let i=t.height;for(let s of this.fft_maxs){let h=s,a=map(h,0,i,150,255);t.fill(a,a,0,this.alpha_hist),t.rect(e,i-h,5,h),e+=this.vol_len}}period_next(){let t=this.output;this.x0=random(t.width/4,t.width-t.width/4),this.y0=random(t.height/4,t.height-t.height/4)}}class q{static meta_props={period:[1,0,.5,1,2,3,4,5,6,8,10,15,20,30,60],next:{button:(t,e)=>{t.next_action(e)}},prev:{button:(t,e)=>{t.prev_action(e)}},step_patch:[0,2,3],_freeze_patch:[0,1],freeze_screen:[0,1],_effects:{style:"width:80%",text_input:"bright,delaunay,grid,maze,sketchy,slant_scan,slit_scan"}};static eff_names=["bright","delaunay","grid","bright","maze","sketchy","slant_scan","slit_scan"];constructor(t){Object.assign(this,t),this.basic_props=Object.assign({},t),this.init()}prepareOutput(){this.advance_check(),this.advancePending&&(this.patch_step(),this.trigger_step(),this.advancePending=0);let t=this.prepare_input(this.eff_inst);t&&(this.freeze_patch&&this.wasFrozen&&this.got_freeze?this.draw_freeze():(t.prepareOutput(),this.output=t.output)),this.period_timer.check((()=>{this.iperiod++,this.has_phase_check||this.possibleAdvance()}))}possibleAdvance(){this.freeze_patch&&this.wasFrozen||(this.advancePending=1)}prepare_input(t){return t&&(t.input=this.input),t}init(){this.effects||(this.effects="show"),this.eff_names=this.effects.split(","),this.index=0,this.eff_inst=null,this.eff_inst_arr=[],this.next_eff(),this.period_timer=new h(this.period),this.iperiod=0,this.img_freeze=createImage(this.input.width,this.input.height)}deinit(){for(let t of this.eff_inst_arr)this.videoKit.deinitEffect(t)}trigger_step(){if(!this.step_patch)return;let t=this.vidoeKit.patch_index1(this.step_patch);t&&t.patch_stepper&&t.patch_stepper()}draw_freeze(){i(this.img_freeze,this.eff_spec.urect)}advance_check(){if(this.freeze_patch){let t=this.videoKit.patch_index1(this.freeze_patch);t&&(this.wasFrozen=t.frozen)}if(this.has_completed_phase){this.eff_inst.completed_phase()&&this.possibleAdvance()}}patch_step(){this.next_eff()}next_action(t){this.next_eff()}prev_action(t){ui_log("eff_loop c index",this.index),this.index=this.index-2;let e=this.eff_names;this.index=(e.length+this.index)%e.length,ui_log("eff_loop d index",this.index),this.next_eff()}async next_eff(){let t=this.eff_names,e=t[this.index];this.index=(this.index+1)%t.length;let i=await this.videoKit.effectMeta_find(e);if(i){ui_log("next_eff effMeta",i.label);let t=this.videoKit.factory_prop_inits(i.factory,this.basic_props);this.prepare_input(t);let e=this.eff_inst_arr[this.index];e&&this.videoKit.deinitEffect(e),e=new i.factory(t),this.eff_inst_arr[this.index]=e,this.eff_inst=e,this.has_completed_phase=this.eff_inst.completed_phase}}}t.prototype.register_effects=function(){this.register_effect("bestill",n),this.register_effect("bright",p),this.register_effect("circle",l),this.register_effect("delaunay",d),this.register_effect("diff",u),this.register_effect("face_mesh",m),this.register_effect("grid",y),this.register_effect("image_url",j),this.register_effect("maze",v),this.register_effect("none",x),this.register_effect("phyllotaxis",w),this.register_effect("pose_net",b),this.register_effect("show",I),this.register_effect("sketchy",z),this.register_effect("slant_scan",M),this.register_effect("slit_scan",O),this.register_effect("triangle",D),this.register_effect("eff_bestill_mo",S),this.register_effect("eff_bodypix",P),this.register_effect("eff_tile_clock",E),this.register_effect("eff_tile_live",C),this.register_effect("eff_image",G),this.register_effect("eff_image_mesh",N),this.register_effect("eff_face_band",V),this.register_effect("eff_fft_graph",H),this.register_effect("eff_fft_polar",U),this.register_effect("eff_loop",q)},t.prototype.register_effect=function(t,e){let i={label:t,factory:e,index:this.a_.effectMetas.length};this.a_.effectMetaDict[t]=i,this.a_.effectMetas.push(i)},t.prototype.media_enum=function(){this.a_.mediaDevices=[],navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then((t=>{t.forEach((t=>{if("videoinput"==t.kind){ui_log("media_enum label="+t.label);let{label:e,deviceId:i}=t;i||(e="No-id-"+random()),this.a_.mediaDevices.push({label:e,deviceId:i})}})),this.create_mediaDevices()})).catch((t=>{ui_log(t.name+": "+t.message)})):ui_log("enumerateDevices() not supported.")},t.prototype.media_reset=function(){ui_log("media_reset"),this.remove_mediaDivs(),this.media_enum()},t.prototype.create_mediaDevices=function(){for(let t of this.a_.mediaDevices)this.init_device_capture(t),this.create_mediaDiv(t,{live:0});this.ui_refresh()},t.prototype.init_device_capture=function(t){let e={audio:this.a_.ui.audio_enabled,video:{deviceId:{exact:t.deviceId}}},i=this.get_capture_size();i&&i.width&&i.height&&(e.video.width={exact:i.width},e.video.height={exact:i.height});let s=createCapture(e,(e=>{t.stream=e,this.livem_restore()}));s.elt.muted=!0,t.capture=s},t.prototype.create_mediaDiv=function(t,e){let i=e.live,s=t.capture,h=t.deviceId,a=t.label;a||(a=h);let r=this.a_.mediaDivs.length,o=this.ui_media_state_default(r,0),n=createDiv();s.elt.parentNode.insertBefore(n.elt,s.elt),(this.a_.hideui||this.a_.hide_ui_option)&&n.hide();let p=createCheckbox("View",o.vis);p.style("display:inline"),n.child(p);let l=createCheckbox("Mute",o.mute);l.style("display:inline"),n.child(l);let _,c=createSpan();n.child(c);let d=()=>{let t=u.info,e=u.capture,i=u.label;u.nlabel&&(i="["+u.nlabel+"] "+u.label),t.html(" "+i+" width="+e.width+" height="+e.height),e.style(u.media_state.vis?"display:inline":"display:none"),e.elt.muted=u.media_state.mute},u={imedia:r,mediaDevice:t,id:h,label:a,div:n,chk:p,media_state:o,capture:s,info:c,ready:function(t){let e=s.loadedmetadata&&s.width>0&&s.height>0;return e?_&&(ui_log(t+" Ready imedia",r),_=0):_||(ui_log(t+" NOT Ready imedia",r),_=1),e},update_info:d},g=this.a_.mediaDivs;if(i){let t=this.a_.lastMediaDivIndex||0;for(;t<g.length&&!(g[t].id>h);t++);g.splice(t,0,u),this.a_.ui.hold_create_media_clear?ui_log("a_.ui.hold_create_media_clear ON"):(ui_log("a_.ui.hold_create_media_clear OFF"),this.patch_instances_clear_all())}else g.push(u),this.a_.lastMediaDivIndex=g.length;d();let f=this;p.changed((function(){u.media_state.vis=this.checked()?1:0,f.ui_media_state_update(u.imedia),d()})),l.changed((function(){u.media_state.mute=this.checked()?1:0,u.capture.elt.muted=u.media_state.mute,f.ui_media_state_update(u.imedia)}))},t.prototype.find_media_by_id=function(t){return t?this.a_.mediaDivs.find((e=>e.id===t)):null},t.prototype.remove_media_by_id=function(t){ui_log("remove_media_by_id id=",t),t&&(this.a_.mediaDivs=this.a_.mediaDivs.filter((e=>e.id!==t)))},t.prototype.remove_mediaDivs=function(){for(let t=this.a_.mediaDivs.length-1;t>0;t--){let e=this.a_.mediaDivs[t];ui_log("remove_mediaDivs index",t,"ent",e),e&&this.remove_mediaDiv(e.id)}},t.prototype.remove_mediaDiv=function(t){let e=this.find_media_by_id(t);e&&(e.div.remove(),e.capture.remove()),this.remove_media_by_id(t)},t.prototype.attach_media_nlabel=function(t,e){let i=this.a_.mediaDivs.find((e=>e.id===t));i&&(i.nlabel=e,i.update_info&&i.update_info())},t.prototype.init_mediaDivs=function({videos:t}){ui_log("init_mediaDivs",t),t=t||[],this.a_.mediaDivs=[{label:"Canvas",capture:this.my_canvas,ready:function(){return 1}}];for(let e of t){let t=this.create_video_Div(e);this.a_.mediaDivs.push(t)}},t.prototype.create_video_Div=function(t){let{label:e,import_path:i}=t,s=createVideo(i,(function(){})),h=!1;s.hide();return{label:e,capture:s,ready:()=>{let t=s.loadedmetadata;return t&&!h&&(ui_log("create_video_Div ready label=",e),s.play(),s.loop(),s.volume(0),h=!0),t}}},t.prototype.ui_media_state_default=function(t,e){let i=this.a_.ui.mediaDiv_states[t];if(i)return i.vis=i.vis?1:0,void 0===i.mute&&(i.mute=1),i.mute=i.mute?1:0,i;return i={vis:e,mute:1},this.a_.ui.mediaDiv_states[t]=i,this.ui_prop_set("mediaDiv_states",this.a_.ui.mediaDiv_states),i},t.prototype.ui_media_state_update=function(t){this.ui_prop_set("mediaDiv_states",this.a_.ui.mediaDiv_states)},t.prototype.liveMedia_attach=function(t){let e,i,s=t.mediaDevice;if(s){if(i=s.stream,!i)return void ui_log("liveMedia_attach NO stream mediaDiv=",t);e="CAPTURE"}else this.a_.ui.canvas_data_chk?(i=null,e="DATA"):(i=this.my_canvas,e="CANVAS");let h=t.livem;if(h)return void ui_log("liveMedia_attach livem",h);let a=this,r=globalThis||window;ui_log("liveMedia_attach this",this,"gthis",r);let o=this.room_name_prefix+this.a_.ui.room_name;ui_log("liveMedia_attach room_name",o),h=new p5LiveMedia(r,e,i,o),a.a_.livem||(h.on("stream",(function(t,e){a.gotStream(t,e)})),h.on("data",(function(t,e){a.gotData(t,e)})),h.on("disconnect",(function(t){a.gotDisconnect(t)})),h.on("connect",(function(t){a.gotConnect(t)})),a.a_.livem=h),t.livem=h},t.prototype.liveMedia_detach=function(t){ui_log("liveMedia_detach mediaDiv=",t),t&&(t.livem=null)},globalThis.otherVideo=0,t.prototype.gotStream=function(t,e){ui_log("gotStream id",e),ui_log("gotStream width",t.width,"height",t.height),globalThis.otherVideo=t,t.elt.muted=!0;let i={deviceId:e,capture:t,stream:t.elt.srcObject};this.create_mediaDiv(i,{live:1}),this.ui_refresh()},t.prototype.gotData=function(t,e){ui_log("gotData theData",t,"id",e),this.ui_chat_receive(t,e)},t.prototype.gotDisconnect=function(t){ui_log("gotDisconnect id",t),this.ui_chat_receive("",t),this.remove_mediaDiv(t)},t.prototype.gotConnect=function(t){ui_log("gotConnect id",t)},t.prototype.livem_send=function(t){if(ui_log("livem_send text",t),!this.a_.livem)return;let e={name:this.a_.ui.chat_name,text:t};this.a_.livem.send(JSON.stringify(e))},t.prototype.reset_video_clear_locals=function(t){this.ui_message("Resetting Configuration",{initTimer:1}),localStorage.clear(),t&&localStorage.setItem("a_.store_name",t);F=createCapture({video:!0},(function(t){ui_log("reset_video_clear_locals create_video stream",t)})),ui_log("reset_video_clear_locals create_video myVideo",F),F.muted=!0;setTimeout((()=>{let t=(random()+"").substring(2);t=this.location_noquery()+"?v="+t,window.location=t}),2e3)},t.prototype.store_url_parse=async function(){let t,e=0,i=window.location.href,s=i.indexOf("?");if(s>=0){let h=function(t){const e=new URLSearchParams(t),i=Object.fromEntries(e);return i}(i.substring(s+1));ui_log("store_url_parse params",h);let a=h.hide;a&&(this.a_.hide_ui_option=parseFloat(a));let r=h.a;r&&(e=this.url_a_restore(r));let o=h.u;o&&(this.a_.store_prefix=o);let n=h.s;if(n){ui_log("store_url_parse s_str",n),t=this.a_.settings.find((t=>t.setting===n)),ui_log("store_url_parse settings",t),this.a_.hideui=1}let p=h.h;p&&(this.a_.hideui=parseFloat(p));let l=h.c;l&&(this.a_.chat_name=l);let _=h.d;if(_){let e="./"+_;t={};try{t=await async function(t){return ui_log("loadJSONAsync url",t),new Promise(((e,i)=>{loadJSON(t,e,i)}))}(e),t.setting||(t.setting=_)}catch(t){ui_log("loadJSON err",t)}}}return{uiSet:e,settings:t}},t.prototype.url_a_restore=function(t){if(t){let e=JSON.parse(t);if(e){this.a_.ui=e;for(let t in this.a_.ui)this.ui_prop_set(t,this.a_.ui[t]);return 1}}return 0},t.prototype.location_noquery=function(){let t=window.location.href,e=t.indexOf("?");return e>=0&&(t=t.substring(0,e)),t},t.prototype.location_url=function(){let t=this.location_noquery();if(t+="?",this.a_.store_prefix){t+="u="+encodeURIComponent(this.a_.store_prefix)+"&"}return t},t.prototype.store_export_json=function(){this.store_export(0)},t.prototype.store_export_url=function(){this.store_export(1)},t.prototype.store_export=function(t){this.pad_layout_update();let e=this.ui_save_fn();saveJSON(this.a_.ui,e);let i=JSON.stringify(this.a_.ui);i=encodeURIComponent(i);let s=this.location_url();s+="a="+i,t&&(window.location=s)},t.prototype.store_name_restore=function(){let t=localStorage.getItem("a_.store_name");return t&&(this.a_.store_name=t),t},t.prototype.store_name_update=function(t){ui_log("store_name_update",t),localStorage.setItem("a_.store_name",t);let e=this.location_url();window.location=e},t.prototype.store_restore_from=function(t){ui_log("store_restore_from ent",t),this.store_save_ent(t);let e=this.location_url();ui_log("store_restore_from loc",e),window.location=e},t.prototype.store_save_ent=function(t){if(this.a_.canvas_size_lock&&(ui_log("store_save_ent ent",t),t.patches))for(let e of t.patches)e.eff_spec.urect_ref=Object.assign({},e.eff_spec.urect);for(let e in t){let i=e;if(this.a_.canvas_size_lock)if("canvas_size"===e)i="canvas_resize_ref";else if("canvas_resize_ref"===e)continue;this.ui_prop_set(i,t[e])}this.a_.canvas_size_lock?this.ui_prop_set("urects_count",0):this.ui_prop_set("canvas_resize_ref","")},t.prototype.ui_create=function(){this.a_.top_dash_div=this.ui_div_empty("id_top_dash"),this.a_.hide_ui_option&&this.a_.top_dash_div.style("display:none"),this.ui_top_pane(),this.ui_size_pane(),this.ui_patch_bar(),this.ui_create_comment_field(),this.ui_createElement("br"),this.ui_patch_eff_panes(),this.ui_patch_buttons(),this.ui_createElement("br"),this.ui_live_selection(),this.ui_chat_pane(),this.ui_createElement("br"),this.a_.top_dash_div=null},t.prototype.ui_top_pane=function(){let t=this.ui_div_empty("itop_bar");this.ui_div_append(t,'\n  <button id="ipresent">Present</button>\n  <button id="ihideui">HideUI</button>\n  <button id="ireset">Reset</button>\n  <button id="isave">Save</button>\n  <button id="ireload">Reload</button>\n  <span id="iu"></span>\n  <span id="ifps"></span>\n  <span id="imsg" style="font-size: 5vw; display: none; float: right"></span>\n  <span>\n    <span style="float: right; margin-right: 5px">\n      <a href="https://github.com/jht9629-nyu/p5videoKit/" target="github" >\n        GitHub\n      </a>\n    </span>\n    <span style="float: right; margin-right: 5px">\n      [ videoKit\n        <a href="./videoKit/settings.html" target="_blank"> Settings </a> \n      ]\n    </span>\n    <span style="float: right; margin-right: 5px">\n      <a href="./gen/settings.html" target="_blank" > Settings </a>\n    </span>\n  </span>\n  '),window.ipresent.addEventListener("mousedown",(()=>{this.present_action()})),window.ihideui.addEventListener("mousedown",(()=>{this.ui_hide()})),window.ireset.addEventListener("mousedown",(()=>{this.reset_video_clear_locals(this.a_.store_name)}));let e=this;window.isave.addEventListener("mousedown",(()=>{if(e.save_canvas_handler)e.save_canvas_handler();else{let t=this.ui_save_fn();saveCanvas(t,"png")}})),window.ireload.addEventListener("mousedown",(()=>{!function(){let t=this.a_.settings.find((t=>t.setting===this.a_.ui.setting));ui_log("reload_action ent",t),t||(t=this.a_.ui);this.store_restore_from(t)}()}));{let t=this.a_.store_prefix;t&&(t="("+t+")"),window.iu.textContent=t}},t.prototype.ui_size_pane=function(){let t=this.ui_div_empty("isize_bar");this.ui_canvas_div(t),this.ui_capture_size(t),this.ui_audio_checkbox(t)},t.prototype.ui_audio_checkbox=function(t){this.ui_div_append(t,'\n  <div style="display: inline">\n    [<input type="checkbox" id="id_audio_checkbox" />\n    <label for="id_audio_checkbox">Audio]</label>\n  </div>\n  ');let e=window.id_audio_checkbox;e.checked=this.a_.ui.audio_enabled,e.addEventListener("change",(function(){ui_log("check_audio_change change nthis",i);let t=this.checked;i.a_.ui.audio_enabled=t?1:0,ui_log("check_audio_change change nthis.a_.ui.audio_enabled",i.a_.ui.audio_enabled),i.ui_prop_set("audio_enabled",i.a_.ui.audio_enabled)}));let i=this},t.prototype.ui_create_comment_field=function(){let t=this.ui_div_empty("icomment_bar");this.ui_div_append(t,'\n  <input id="icomment_input" value="" type="text" style="width: 80%;">\n  ');let e=this.a_.ui.comment||this.a_.ui.setting;window.icomment_input.value=e;let i=this;window.icomment_input.addEventListener("input",(function(){let t=this.value;i.ui_prop_set("comment",t)}))},t.prototype.ui_present_window=function(){resizeCanvas(windowWidth,windowHeight),this.ui_hide(),this.ui_window_refresh()},t.prototype.present_action=function(){this.toggleFullScreen();setTimeout((()=>{this.ui_present_window()}),3e3)},t.prototype.ui_window_refresh=function(){ui_log("ui_window_refresh"),this.pad_layout_update(),this.patch_instances_clear_all()},t.prototype.update_ui=function(){T||(T=select("#ifps")),T&&T.html(" [fps="+round(frameRate(),2)+"] ")},t.prototype.ui_save_fn=function(){let t=this.a_.ui.comment||this.a_.ui.setting||"videoKit";return t=t.substring(0,32),t+"_"+(new Date).toISOString().substring(0,10)};class X{constructor(t){this.tiled="Single"!==t.ui.patch_layout;let e={width:width,height:height,x0:0,y0:0};this.io=Object.assign({},e);let i=this.io;if(!this.tiled)return;let s=t.ui.patch_layout.split("x"),h=parseFloat(s[0]),a=parseFloat(s[1]);i.xs=Math.floor(i.width/h),i.ys=Math.floor(i.height/a),i.x=0,i.y=0}next(){let t=this.io;if(!this.tiled)return t;let e={x0:t.x,y0:t.y,width:t.xs,height:t.ys};return t.x+=t.xs,t.x+t.xs/2>=t.width&&(t.x=0,t.y+=t.ys,t.y>=t.height&&(t.y=0)),e}}t.prototype.ui_canvas_div=function(t){let e=`\n  <span>[Canvas Size: </span>\n  <select id=icanvas_size>\n    ${function(t){let e=t.map((t=>`<option value="${t.label}">${t.label}</option>`));return e.join("")}($)}\n  </select>\n  <div style="display: inline">\n    <input type="checkbox" id="icanvas_lock" />\n    <label for="icanvas_lock">Lock]</label>\n  </div>\n  `;this.ui_div_append(t,e);let i=window.icanvas_size,s=this.canvas_size_default();i.selectedIndex=s.index,i.addEventListener("change",(function(){let t=this.selectedIndex,e=$[t];e.func?e.func():e.width?(h.ui_prop_set("canvas_size",e.label),resizeCanvas(e.width,e.height)):ui_log("No canvas size in se",e);h.ui_window_refresh()}));let h=this;let a=window.icanvas_lock;a.checked=this.a_.canvas_size_lock,a.addEventListener("change",(function(){let t=this.checked;h.a_.canvas_size_lock=t?1:0,h.store_set("a_.canvas_size_lock",h.a_.canvas_size_lock+"")}))},t.prototype.ui_canvas_init=function(){K=this.init_size_in($)},t.prototype.canvas_size_default=function(){let t=K[this.a_.ui.canvas_size];return t||$[0]},t.prototype.init_size_in=function(t){let e={},i=0;for(let s of t)s.label||(s.label=s.width+"x"+s.height),s.index=i,e[s.label]=s,i++;return e},t.prototype.str_to_width_height=function(t){let e=t.split("x");return{width:parseFloat(e[0]),height:parseFloat(e[1])}},t.prototype.toggleFullScreen=function(){document.documentElement.requestFullscreen?document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen():ui_log("NO document.documentElement.requestFullscreen")};let Y,$=[{width:320,height:240},{width:480,height:270},{width:640,height:480},{width:960,height:540},{width:1280,height:720},{width:1920,height:1080},{width:3840,height:2160},{width:270,height:480},{width:480,height:640},{width:540,height:960},{width:1080,height:1920},{width:2160,height:3840},{label:"Window",func:function(){resizeCanvas(windowWidth,windowHeight)}},{label:"Display",func:function(){resizeCanvas(displayWidth,displayHeight)}},{label:"Full Screen",func:()=>{resizeCanvas(windowWidth,windowHeight)}}];t.prototype.ui_capture_size=function(t){let e=`\n  <span> Capture Size: </span>\n  <select id=icapture_size>\n    ${function(t){let e=t.map((t=>`<option value="${t.label}">${t.label}</option>`));return e.join("")}(B)}\n  </select>\n  `;this.ui_div_append(t,e);let i=window.icapture_size,s=this.get_capture_size();i.selectedIndex=s.index,i.addEventListener("change",(function(){ui_log("capture_size change value",this.value);let t=this.value;h.ui_prop_set("capture_size",t),h.media_reset(),h.patch_instances_clear_all()}));let h=this},t.prototype.ui_capture_init=function(){Y=this.init_size_in(B)},t.prototype.get_capture_size=function(){let t=Y[this.a_.ui.capture_size];return t||B[1]};let W,B=[{label:"default"},{width:320,height:240},{width:480,height:270},{width:270,height:480},{width:640,height:480},{width:960,height:540},{width:1920,height:1080},{width:3840,height:2160},{width:20,height:15},{width:40,height:30},{width:80,height:60},{width:160,height:120}];t.prototype.ui_chat_pane=function(){let t,e=createSpan("").id("ichat_blk");this.a_.top_dash_div&&this.a_.top_dash_div.child(e),e.style(this.a_.ui.live_chk?"display:inline":"display:none"),t=createSpan(" Chat name: "),e.child(t),t=createInput(this.a_.ui.chat_name).input((()=>{this.ui_prop_set("chat_name",this.value())})),e.child(t),t=createButton("Send").mousePressed((()=>{let t=select("#ichat_msg").value();this.livem_send(t),select("#ichat_log").html("me: "+t+"<br/>",!0)})),e.child(t),t=createButton("Clear").mousePressed((()=>{select("#ichat_msg").value(""),select("#ichat_log").html("")})),e.child(t),t=createElement("br"),e.child(t);let i=this;t=createInput("").id("ichat_msg").input((function(){ui_log("ichat_msg "+this.value()),i.ui_prop_set("chat_text",this.value())})),e.child(t),select("#ichat_msg").style("width","80%"),t=createDiv().id("ichat_log"),e.child(t),W=t},t.prototype.ui_chat_receive=function(t,e){let i={name:e,text:"Bye"};if(t&&(i=JSON.parse(t),!i))return;let{name:s,text:h}=i;h||(h=""),s===this.a_.ui.chat_name&&(s+="-"+e),W.html(s+": "+h+"<br/>",!0),this.attach_media_nlabel(e,s),"tile"===s&&"restart"===h&&window.location.reload()},t.prototype.ui_live_selection=function(){let t=this.ui_div_empty("live_selection"),e=createCheckbox("Live ",this.a_.ui.live_chk);t.child(e),e.style("display:inline");let i=this;e.changed((function(){let t=this.checked();i.ui_prop_set("live_chk",t?1:0),select("#ichat_blk").style(i.a_.ui.live_chk?"display:inline":"display:none"),i.livem_restore()})),t.child(createSpan("Device: "));let s=createSelect();t.child(s);for(let t=0;t<this.a_.mediaDivs.length;t++){let e=this.a_.mediaDivs[t];s.option(e.label,t)}s.selected(this.a_.ui.live_index),s.changed((function(){let t=parseFloat(this.value());ui_log("ui_live_selection index",t),i.ui_prop_set("live_index",t);let e=i.media_for_livem_index(t);i.a_.ui.live_chk?i.liveMedia_attach(e):i.liveMedia_detach(e)}));{let e=createSpan("Room: ");t.child(e),e=createInput(this.a_.ui.room_name).input((function(){i.ui_prop_set("room_name",this.value())})),t.child(e)}{let e=createCheckbox("Data ",this.a_.ui.canvas_data_chk);t.child(e),e.style("display:inline"),e.changed((function(){let t=this.checked();i.ui_prop_set("canvas_data_chk",t?1:0)}))}},t.prototype.media_for_livem_index=function(t){return this.a_.mediaDivs[t]},t.prototype.livem_restore=function(){if(!this.a_.livem&&this.a_.ui.live_chk){ui_log("livem_restore this.a_.ui.live_index",this.a_.ui.live_index);let t=this.media_for_livem_index(this.a_.ui.live_index);ui_log("livem_restore mediaDiv",t),t&&this.liveMedia_attach(t)}},t.prototype.ui_message=function(t,e){e&&e.initTimer&&(dice.startTime=window.performance.now());let i=select("#imsg");i&&(t?(Q=t=" [ "+t+" ] ",Z>0&&clearInterval(Z),Z=setInterval(et,tt)):Z>0&&(clearInterval(Z),Z=-1),i.html(t),i.style(t?"display:inline":"display:none"))};let Q,Z=-1,tt=100;function et(){let t=select("#imsg");if(!t)return;let e=window.performance.now()-dice.startTime;e/=1e3,e=Math.floor(100*e)/100;let i=e+" "+Q;t.html(i),t.style(i?"display:inline":"display:none")}let it=["Single","1x1","2x1","2x2","2x3","3x2","3x3","3x1","4x4","1x4"],st=[0,1,50,100,200,255,-1];function ht(t){for(let e in t)t[e]=Math.floor(t[e]*this.a_.ui.urects_scale)}function at(t){let{div:e,prop:i,defaultLabel:s}=t;if(s=s||i,s){let i=createSpan(` ${s}:`);e.child(i),t.labelSpan=i}}function rt(t,e){let{item:i,aPatch:s,prop:h}=e;at(e);let a=s.eff_props[h];void 0===a&&(a=""+i,s.eff_props[h]=a),e.elm=createInput(a).input((function(){let e=this.value();ui_log("text_input "+e),s.eff_props[h]=e,t.ui_patch_update(s)})),e.div.child(e.elm)}function ot(t,e){let{item:i,aPatch:s,div:h,prop:a}=e;at(e);let r=i,o=createSelect();h.child(o);for(let t=0;t<r.length;t++)o.option(r[t]);let n=s.eff_props[a];void 0===n&&(n=r[0],s.eff_props[a]=n);let p="number"==typeof n;null===n&&(n=""),o.selected(n),o.changed((function(){let e=this.value();p&&(e=parseFloat(e)),s.eff_props[a]=e,t.ui_patch_update(s)})),e.elm=o}function nt(t,e){let{item:i,aPatch:s,div:h,prop:a}=e;at(e);let r=i.min||0,o=i.max||1,n=i.step||0,p=s.eff_props[a];void 0===p&&(p=void 0!==e.defaultValue?e.defaultValue:r+(o-r)/2,s.eff_props[a]=p);let l=createSpan(pt(p));e.elm=createSlider(r,o,p,n).input((function(){let e=this.value();s.eff_props[a]=e,t.ui_patch_update(s),l.elt.innerHTML=pt(e)+""})),h.child(e.elm),h.child(l)}function pt(t){return int(1e3*t)/1e3}t.prototype.ui_patch_bar=function(){let t=this.ui_div_empty("ipatch_bar"),e=`\n  <span>Layout: </span>\n  <select id="ilayout">\n    ${i=it,i.map((t=>`<option value="${t}">${t}</option>`)).join("")}\n  </select>\n  <span> BackColor: </span>\n  <select id="iback_color">\n    ${function(t){let e=t.map((t=>`<option value="${t}">${t}</option>`));return e.join("")}(st)}\n  </select>\n  <button id="iexport">Export</button>\n  <button id="ixurl">URL</button>\n  <span> Setting: </span>\n  <select id="isettings">\n    ${function(t){let e=t.map(((t,e)=>`<option value="${e}">${t.setting}</option>`));return e.join("")}(this.a_.settings)}\n  </select>\n  `;var i;this.ui_div_append(t,e);let s=window.ilayout;s.selectedIndex=it.findIndex((t=>t===this.a_.ui.patch_layout)),s.addEventListener("change",(function(){h.ui_prop_set("patch_layout",this.value),h.pad_layout_update(),h.patch_instances_clear_all()}));let h=this;let a=window.iback_color;a.selectedIndex=st.findIndex((t=>parseFloat(t)===this.a_.ui.back_color)),a.addEventListener("change",(function(){let t=parseFloat(this.value);h.ui_prop_set("back_color",t)}));let r=window.isettings;r.selectedIndex=this.a_.settings.findIndex((t=>t.setting===this.a_.ui.setting)),r.addEventListener("change",(function(){let t=parseFloat(this.value),e=h.a_.settings[t];h.store_restore_from(e)})),window.iexport.addEventListener("mousedown",(function(){h.store_export_json()})),window.ixurl.addEventListener("mousedown",(function(){h.store_export_url()}))},t.prototype.ui_patch_buttons=function(){let t=this;this.ui_createButton("Add Effect").mousePressed((function(){t.patch_add({eff_spec:{ipatch:0,imedia:1,eff_label:"show"}})})),this.ui_createElement("br")},t.prototype.ui_refresh=function(){this.a_.hideui||(this.ui_live_selection(),this.ui_patch_eff_panes())},t.prototype.ui_patch_update=function(t){if(this.ui_prop_set("patches",this.a_.ui.patches),!t)return;let e=t.eff_spec.ipatch;this.patch_inst_update(e),this.a_.patch_instances[e]=null},t.prototype.pad_layout_update=function(){let t;if(this.a_.ui.canvas_resize_ref)!function(){let t=this.str_to_width_height(this.a_.ui.canvas_resize_ref),e=this.str_to_width_height(this.a_.ui.canvas_size);this.a_.ui.urects_scale=e.width/t.width,ui_log("pads_resize_set_scale this.a_.ui.canvas_resize_ref",this.a_.ui.canvas_resize_ref),ui_log("pads_resize_set_scale this.a_.ui.canvas_size",this.a_.ui.canvas_size),ui_log("pads_resize_set_scale urects_scale",this.a_.ui.urects_scale)}();else{if(this.a_.ui.urects_lock)return void ui_log("pad_layout_update this.a_.ui.urects_lock");t=new X(this.a_)}let e,i=0;for(let s=0;s<this.a_.ui.patches.length;s++){let h=this.a_.ui.patches[s];if(h){let a=h.eff_spec;a.ipatch!=s&&(ui_log("!!@ eff_spec.ipatch",a.ipatch,"ipatch",s),a.ipatch=s),t?e=t.next():a.urect_ref?(e=Object.assign({},a.urect_ref),ui_log("pad_layout_ assign pad",JSON.stringify(e)),ht(e)):ui_log("!!@ pad_layout_update urects_ref missing ipatch",s,"uiPatch",JSON.stringify(h)),a.urect=e,i++}}this.ui_prop_set("patches",this.a_.ui.patches),this.ui_prop_set("urects_count",i)},t.prototype.patch_create_other=function(t,e,i,s,h){let a=0,r={aPatch:t,div:e,prop:i};for(let t in s){let e=s[t];switch(r.item=e,t){case"style":r.defaultStyle=e;break;case"label":r.defaultLabel=e;break;case"default":r.defaultValue=e}}for(let e in s){let h=s[e];switch(r.item=h,e){case"style":case"label":case"default":case"prop":break;case"button":r.div.child(createSpan(" "));let s=r.defaultLabel||i;r.elm=createButton(s).mousePressed((()=>{this.button_action(h,t)})),r.div.child(r.elm);break;case"textInput":case"text_input":rt(this,r);break;case"span":case"message":r.elm=createSpan(` ${h}`),r.div.child(r.elm);break;case"slider":nt(this,r);break;case"selection":ot(this,r);break;case"br":a=1;break;default:ui_log("create_other !!@ Unkown type="+e)}}if(r.elm){if(h){(r.labelSpan||r.elm).style("margin-left:10px")}return r.defaultStyle&&r.elm.style(r.defaultStyle),a}return 1},t.prototype.button_action=function(t,e){t(this.a_.patch_instances[e.eff_spec.ipatch],e)},t.prototype.ui_patch_eff_panes=async function(){let t=this.ui_div_empty("ipatch_eff");for(let e=0;e<this.a_.ui.patches.length;e++)await this.create_patch(t,e)},t.prototype.create_patch=async function(t,e){let i=this.ui_div_empty("patch_"+e);t.child(i);let s=this.a_.ui.patches[e];s.eff_props||(s.eff_props={}),this.create_patch_selection(s,e,i),this.create_media_selection(s,i),this.create_checkbox(s,i,"pipe","ipipe"),this.create_checkbox(s,i,"hide","ihide"),this.create_checkbox(s,i,"fliph","ifliph"),this.create_checkbox(s,i,"flipv","iflipv"),this.create_remove_patch(e,i),await this.create_settings(s,i)},t.prototype.create_remove_patch=function(t,e){let i=this,s=createButton("Remove").mousePressed((function(){i.patch_remove_ipatch(t)}));e.child(s)},t.prototype.create_checkbox=function(t,e,i,s){let h=createCheckbox(i,t.eff_spec[s]||!1);e.child(h),h.style("display:inline");let a=this;h.changed((function(){let e=this.checked()?1:0;t.eff_spec[s]=e,a.ui_patch_update(t)}))},t.prototype.create_patch_selection=async function(t,e,i){let s=createSpan(`Effect${e+1}: `);i.child(s);let h=createSelect();i.child(h);for(let t=0;t<this.a_.effectMetas.length;t++){let e=this.a_.effectMetas[t],i=e.ui_label||e.label;i=e.ui_label?e.ui_label:e.label,h.option(i,t)}let a=(await this.effectMeta_find(t.eff_spec.eff_label)).index;h.selected(a);let r=this;h.changed((function(){let e=parseFloat(this.value());e>=0&&r.patch_update_effIndex(t,e)}))},t.prototype.create_media_selection=function(t,e){let i=createSpan(" Source: ");e.child(i);let s=createSelect();e.child(s);for(let t=0;t<this.a_.mediaDivs.length;t++)s.option(this.a_.mediaDivs[t].label,t);s.selected(t.eff_spec.imedia);let h=this;s.changed((function(){let e=this.value();t.eff_spec.imedia=parseFloat(e),h.ui_patch_update(t)}))},t.prototype.create_settings=async function(t,e){let i=await this.effectMeta_find(t.eff_spec.eff_label);i.factory?this.create_ui_for_meta(t,e,i.factory.meta_props):ui_log("create_settings MISSING factory effMeta",i),this.div_break(e),this.div_break(e)},t.prototype.create_ui_for_meta=function(t,e,i){Array.isArray(i)?this.create_ui_for_meta_arr(t,e,i):this.create_ui_for_meta_dict(t,e,i)},t.prototype.create_ui_for_meta_arr=function(t,e,i){let s=1;for(let h of i){s&&this.div_break(e);let i=h.prop;s=this.patch_create_other(t,e,i,h,s)}},t.prototype.create_ui_for_meta_dict=function(t,e,i){let s=1;for(let h in i){let a=i[h];"_"===h.substring(0,1)&&(h=h.substring(1),s=1),s&&this.div_break(e),Array.isArray(a)?(this.patch_create_selection(t,e,h,a,s),s=0):s=this.patch_create_other(t,e,h,a,s)}},t.prototype.patch_create_selection=function(t,e,i,s,h,a){let r=createSpan(` ${a||i}:`);e.child(r),h&&r.style("margin-left","10px");let o=createSelect();e.child(o);for(let t=0;t<s.length;t++)o.option(s[t]);let n=t.eff_props[i];void 0===n&&(n=s[0],t.eff_props[i]=n);let p="number"==typeof n;o.selected(n);let l=this;return o.changed((function(){let e=this.value();p&&(e=parseFloat(e)),t.eff_props[i]=e,l.ui_patch_update(t)})),o},t.prototype.patch_index1=function(t){return this.a_.patch_instances[t-1]},t.prototype.div_break=function(t){t.child(createElement("br"))},t.prototype.ui_prop_set=function(t,e){this.a_.ui[t]=e;let i=JSON.stringify([e]);this.store_set("a_.ui_"+t,i)},t.prototype.store_ref=function(t){return this.a_.store_prefix+this.a_.store_name.substring(6,7)+t.substring(1)},t.prototype.store_set=function(t,e){localStorage.setItem(this.store_ref(t),e)},t.prototype.store_get=function(t){return localStorage.getItem(this.store_ref(t))},t.prototype.store_remove=function(t){return localStorage.removeItem(this.store_ref(t))},t.prototype.store_clear_all=function(){localStorage.clear()};let lt=[];function _t(e,i=p5.instance){return ct("p5videoKit_init config",e,"p5_instance",!!i),new t(e,i)}function ct(...t){console.log(...t)}t.prototype.ui_restore_store=async function({effects:t,settings:e}){t=t||[],e=e||[];let i=window.performance.now();if(!this.store_name_restore()&&!window.location.search)return this.a_.store_name||(this.a_.store_name="Store-A"),ui_log("ui_restore_store this.a_.store_name",this.a_.store_name),void this.reset_video_clear_locals(this.a_.store_name);this.a_.effectMetas=t.concat([{label:"----"}],lt),this.a_.settingMetas=e,await this.effectMeta_init(),await this.settingMetas_init(),this.register_effects(),this.ui_capture_init(),this.ui_canvas_init();let s=await this.store_url_parse();s.uiSet||(this.store_restore_ver(),this.store_restore_canvas_lock(),this.store_restore_ui(s.settings));let h=this.canvas_size_default(),a=window.performance.now()-i;return ui_log("ui_restore lapse",a),h},t.prototype.settingMetas_init=async function(){this.a_.settings=[{setting:""}];let t=[],e=1;for(let i of this.a_.settingMetas)t.push(this.setting_import(i,e)),e++;await Promise.allSettled(t)},t.prototype.setting_import=function(t,e){let i="./"+t.import_path;return new Promise(((s,h)=>{loadJSON(i,(i=>{i.setting=t.label,this.a_.settings[e]=i,s()}),(t=>{ui_log("setting_import error url",i,"error",t),ui_log("setting_import error index",e),this.a_.settings[e]={setting:"Missing"},h(t)}))}))},t.prototype.store_restore_canvas_lock=function(){let t=this.store_get("a_.canvas_size_lock");t&&(this.a_.canvas_size_lock=parseFloat(t))},t.prototype.store_restore_ui=function(t){this.a_.ui.urects_count=0,this.a_.ui.urects_lock=0,t?this.store_restore_settings(t):this.store_restore_store_get(),this.a_.chat_name&&(this.a_.ui.chat_name=this.a_.chat_name)},t.prototype.store_restore_settings=function(t){if(this.a_.ui=t,this.store_save_ent(t),this.a_.hideui){setTimeout((()=>{this.ui_present_window()}),3e3)}},t.prototype.store_restore_store_get=function(){for(let t in this.a_.ui){let e=this.store_get("a_.ui_"+t);null!==e&&(e=JSON.parse(e),Array.isArray(e)?(e=e[0],this.a_.ui[t]=e):ui_log("store_restore_store_get skipping prop="+t+" valu="+e))}},t.prototype.store_restore_ver=function(){let t=this.store_get("a_.store_ver");if(t!==this.a_.store_ver){ui_log("store_restore_ver reset ver="+t),this.store_set("a_.store_ver",this.a_.store_ver);for(let t in this.a_.ui)this.store_remove(t)}},t.prototype.ui_createButton=function(t){let e=createButton(t);return this.a_.top_dash_div&&this.a_.top_dash_div.child(e),e},t.prototype.ui_createElement=function(t){let e=createElement("tag");return this.a_.top_dash_div&&this.a_.top_dash_div.child(e),e},t.prototype.ui_div_append=function(t,e){let i=document.createElement("div");i.innerHTML=e;let s=i.childNodes.values(),h=[];for(let t of s)h.push(t);for(let e of h)t.elt.appendChild(e)},t.prototype.ui_div_empty=function(t){let e=select("#"+t);if(e){let t=e.child();for(let e=t.length-1;e>=0;e--){t[e].remove()}}else e=createDiv().id(t),this.a_.top_dash_div&&this.a_.top_dash_div.child(e);return e},t.prototype.ui_hide=function(){this.my_canvas.elt.style.cursor="none";let t=select("main").elt;for(;t.nextSibling;)"VIDEO"===t.nextSibling.nodeName?t=t.nextSibling:t.nextSibling.remove()},globalThis.p5videoKit_init=_t,globalThis.ui_log=ct,globalThis.ui_verbose=function(...t){};export{_t as p5videoKit_init};
//# sourceMappingURL=p5videoKit.esm.js.map
